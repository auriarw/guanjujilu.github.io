<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹å‰§è§‚æ¼”è®°å½•</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8B2635;
            --primary-light: #A63446;
            --secondary: #FF9F66;
            --bg-main: #FFF9F0;
            --bg-card: #FFFFFF;
            --text-primary: #2C1810;
            --text-secondary: #6B5444;
            --border: #E8DDD0;
            --shadow: rgba(139, 38, 53, 0.1);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #FFF9F0 0%, #F5EDE0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 20px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            position: relative;
            overflow: hidden;
        }

        h1 {
            font-family: 'Noto Serif SC', serif;
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
        }

        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tab {
            padding: 12px 28px;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-tab:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--border);
        }

        .card-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.8em;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
            border-bottom: 2px solid var(--secondary);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1em;
            font-family: inherit;
            transition: all 0.3s ease;
            background: var(--bg-main);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 38, 53, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 12px 32px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .btn:hover {
            background: var(--primary-light);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: #C5A028;
        }

        .btn-small {
            padding: 6px 16px;
            font-size: 0.9em;
        }

        .records-list {
            display: grid;
            gap: 15px;
        }

        .record-item {
            background: var(--bg-main);
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }

        .record-item:hover {
            box-shadow: 0 4px 15px var(--shadow);
            transform: translateX(5px);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .record-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3em;
            font-weight: 600;
            color: var(--primary);
        }

        .record-type {
            display: inline-block;
            padding: 4px 12px;
            background: var(--secondary);
            color: var(--text-primary);
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .record-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 12px;
            font-size: 0.95em;
            color: var(--text-secondary);
        }

        .record-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .record-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .calendar-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary);
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: 600;
            padding: 10px;
            color: var(--text-secondary);
        }

        .calendar-day {
            height: 120px;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 0;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-day:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .calendar-day.has-show {
            border-color: var(--primary);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .day-number {
            font-weight: 600;
            font-size: 0.85em;
            padding: 4px 6px;
            background: rgba(255, 255, 255, 0.95);
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            border-bottom-right-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .calendar-day.has-show .day-number {
            background: rgba(139, 38, 53, 0.9);
            color: white;
        }

        .day-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            width: 100%;
            height: 100%;
        }

        .day-image-split {
            flex: 1;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            min-height: 0;
        }

        .day-image-split:last-child {
            border-bottom: none;
        }

        .day-image-split img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .day-image-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85) 0%, rgba(0, 0, 0, 0.5) 70%, transparent 100%);
            color: white;
            font-size: 0.65em;
            padding: 3px 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.3;
        }

        .day-text-only {
            padding: 28px 6px 6px 6px;
            font-size: 0.75em;
            display: flex;
            flex-direction: column;
            gap: 3px;
            overflow-y: auto;
        }

        .day-text-item {
            padding: 3px 5px;
            background: var(--primary);
            color: white;
            border-radius: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .cast-badge {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 20px;
            background: var(--bg-main);
            border: 2px solid var(--border);
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 0.9em;
        }

        .cast-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .cast-badge.watched {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: var(--primary);
        }

        .cast-badge-count {
            position: absolute;
            bottom: -4px;
            right: -4px;
            background: var(--secondary);
            color: white;
            font-size: 0.7em;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .show-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .show-card-preview {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px var(--shadow);
            border: 2px solid var(--border);
        }

        .show-card-preview:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px var(--shadow);
            border-color: var(--primary);
        }

        .show-card-preview img {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
        }

        .show-card-info {
            padding: 12px;
        }

        .show-card-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .show-card-venue {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .show-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .unlock-progress {
            background: var(--bg-main);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }

        .unlock-stats {
            font-size: 1.2em;
            color: var(--primary);
            font-weight: 600;
        }

        .unlock-bar {
            width: 100%;
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .unlock-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary) 0%, var(--primary-light) 100%);
            transition: width 0.3s ease;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: var(--bg-main);
            border: 2px solid var(--border);
            border-radius: 20px;
            color: var(--text-primary);
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            border-color: var(--primary);
            transform: translateX(-3px);
        }

        .role-section {
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-main);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }

        .role-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .cast-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .show-info-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px var(--shadow);
            border: 1px solid var(--border);
        }

        .show-poster {
            width: 100%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 12px var(--shadow);
            margin-bottom: 15px;
        }

        .role-input-group {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .cast-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .cast-input-row input {
            flex: 1;
        }

        .btn-remove {
            padding: 8px 12px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .btn-add-small {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .show-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .show-grid-item {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid var(--border);
        }

        .show-grid-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow);
            border-color: var(--primary);
        }

        .show-grid-poster {
            width: 100%;
            aspect-ratio: 2/3;
            object-fit: cover;
            background: var(--bg-main);
        }

        .show-grid-info {
            padding: 12px;
        }

        .show-grid-name {
            font-weight: 600;
            font-size: 1.1em;
            color: var(--text-primary);
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .show-grid-stats {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .show-detail-modal .modal-content {
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .unlock-progress {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: linear-gradient(135deg, var(--secondary) 0%, #9F8FD9 100%);
            color: white;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1em;
        }

        .unlock-progress-bar {
            width: 100px;
            height: 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .unlock-progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .autocomplete-dropdown {
            position: absolute;
            background: white;
            border: 2px solid var(--border);
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
        }

        .autocomplete-dropdown.active {
            display: block;
        }

        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background 0.2s ease;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .autocomplete-item:hover {
            background: var(--bg-main);
        }

        .autocomplete-item strong {
            color: var(--primary);
        }

        .batch-parse-section {
            background: var(--bg-main);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .batch-parse-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95em;
            resize: vertical;
        }

        .batch-parse-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .batch-parse-hint {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: 5px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: var(--bg-main);
            border-radius: 10px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 10px var(--shadow);
        }

        .ranking-number {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--secondary);
            min-width: 50px;
        }

        .ranking-number.top {
            color: var(--primary);
            font-size: 2em;
        }

        .ranking-name {
            flex: 1;
            font-weight: 500;
            margin: 0 20px;
        }

        .ranking-count {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--primary);
            min-width: 60px;
            text-align: right;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .stat-number {
            font-family: 'Noto Serif SC', serif;
            font-size: 3em;
            font-weight: 700;
            display: block;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.5em;
            font-weight: 600;
            color: var(--primary);
        }

        .close-btn {
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary);
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-btn:hover {
            color: var(--primary);
        }

        .image-upload {
            margin-top: 10px;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .image-preview-item {
            position: relative;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid var(--border);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .calendar-grid {
                gap: 5px;
            }

            .calendar-day {
                height: 100px;
            }

            .day-number {
                font-size: 0.7em;
                padding: 3px 5px;
            }

            .day-text-only {
                padding: 24px 5px 5px 5px;
                gap: 2px;
            }

            .day-text-item {
                font-size: 0.8em;
                padding: 2px 4px;
            }

            .day-image-overlay {
                font-size: 0.6em;
                padding: 2px 4px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æˆ‘çš„è§‚æ¼”è®°å½•</h1>
            <div class="subtitle">å¤šçœ‹å¥½å‰§å°‘è¢«åˆ›</div>
        </header>

        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('add')">â• æ·»åŠ è®°å½•</div>
            <div class="nav-tab" onclick="switchTab('list')">ğŸ“‹ æ‰€æœ‰è®°å½•</div>
            <div class="nav-tab" onclick="switchTab('calendar')">ğŸ“… æ—¥å†è§†å›¾</div>
            <div class="nav-tab" onclick="switchTab('rankings')">ğŸ“Š æ’è¡Œæ¦œ</div>
            <div class="nav-tab" onclick="switchTab('summary')">ğŸ“ˆ ç»Ÿè®¡æ€»ç»“</div>
            <div class="nav-tab" onclick="switchTab('showInfo')">ğŸ“– å‰§ç›®ä¿¡æ¯</div>
            <div class="nav-tab" onclick="switchTab('data')">ğŸ’¾ æ•°æ®ç®¡ç†</div>
        </div>

        <!-- æ·»åŠ è®°å½• -->
        <div id="tab-add" class="tab-content active">
            <div class="card">
                <h2 class="card-title">æ·»åŠ æ–°è®°å½•</h2>
                <form id="addForm">
                    <div class="form-group">
                        <label>å‰§ç›®åç§° *</label>
                        <div style="position: relative;">
                            <input type="text" id="showName" required autocomplete="off">
                            <div id="showNameDropdown" class="autocomplete-dropdown"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>å‰§ç§ *</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-small btn-secondary" onclick="document.getElementById('showType').value='éŸ³ä¹å‰§'">éŸ³ä¹å‰§</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="document.getElementById('showType').value='è¯å‰§'">è¯å‰§</button>
                        </div>
                        <input type="text" id="showType" placeholder="ä¾‹å¦‚ï¼šéŸ³ä¹å‰§ã€æ­Œå‰§ã€è¯å‰§" required>
                    </div>
                    <div class="form-group">
                        <label>è§‚æ¼”æ—¥æœŸ *</label>
                        <input type="date" id="showDate" required>
                    </div>
                    <div class="form-group">
                        <label>å…·ä½“æ—¶é—´</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;">
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('14:00')">14:00</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('14:30')">14:30</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('17:00')">17:00</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('19:00')">19:00</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('19:30')">19:30</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('20:00')">20:00</button>
                            <button type="button" class="btn btn-small btn-secondary" onclick="setTime('20:30')">20:30</button>
                        </div>
                        <input type="time" id="showTime" placeholder="æˆ–è‡ªå·±å¡«å†™æ—¶é—´">
                    </div>
                    <div class="form-group">
                        <label>å¡å¸</label>
                        
                        <!-- å¦‚æœå‰§ç›®æœ‰å¡å¸ä¿¡æ¯ï¼Œæ˜¾ç¤ºæŒ‰è§’è‰²åˆ†ç»„çš„æŒ‰é’® -->
                        <div id="castSelectionArea" style="display: none; margin-bottom: 15px;">
                            <div id="castButtonsByRole"></div>
                        </div>
                        
                        <div class="batch-parse-section">
                            <label style="font-weight: 600; margin-bottom: 8px; display: block;">æ‰¹é‡è¯†åˆ«æ¼”å‘˜</label>
                            <textarea id="castBatchInput" class="batch-parse-textarea" placeholder="ç²˜è´´æ¼”å‘˜åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªæˆ–ç”¨é€—å·åˆ†éš”&#10;ä¾‹å¦‚ï¼š&#10;å¼ ä¸‰&#10;æå››&#10;ç‹äº”&#10;&#10;æˆ–ï¼šå¼ ä¸‰, æå››, ç‹äº”"></textarea>
                            <div class="batch-parse-hint">ğŸ’¡ ç²˜è´´åè‡ªåŠ¨è¯†åˆ«ï¼Œæ”¯æŒæ¢è¡Œæˆ–é€—å·åˆ†éš”</div>
                        </div>
                        <label style="font-weight: 600; margin-top: 15px; display: block;">æˆ–æ‰‹åŠ¨è¾“å…¥ï¼ˆå¤šä¸ªæ¼”å‘˜ç”¨é€—å·åˆ†éš”ï¼‰</label>
                        <input type="text" id="showCast" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰, æå››, ç‹äº”">
                    </div>
                    <div class="form-group">
                        <label>åº§ä½</label>
                        <input type="text" id="showSeat" placeholder="ä¾‹å¦‚ï¼šä¸€æ¥¼5æ’8åº§">
                    </div>
                    <div class="form-group">
                        <label>å¤‡æ³¨</label>
                        <textarea id="showNotes" placeholder="è®°å½•ä½ çš„è§‚æ¼”æ„Ÿå—..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>ç…§ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                        <input type="file" id="showImages" accept="image/*" multiple class="image-upload">
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                    <button type="submit" class="btn">ä¿å­˜è®°å½•</button>
                </form>
            </div>
        </div>

        <!-- æ‰€æœ‰è®°å½• -->
        <div id="tab-list" class="tab-content">
            <div class="card">
                <h2 class="card-title">æ‰€æœ‰è§‚æ¼”è®°å½•</h2>
                <div id="recordsList" class="records-list"></div>
            </div>
        </div>

        <!-- æ—¥å†è§†å›¾ -->
        <div id="tab-calendar" class="tab-content">
            <div class="card">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h2 class="calendar-title" id="calendarTitle"></h2>
                        <div class="calendar-nav">
                            <button class="btn btn-small" onclick="changeMonth(-1)">â† ä¸Šæœˆ</button>
                            <button class="btn btn-small btn-secondary" onclick="goToToday()">ä»Šå¤©</button>
                            <button class="btn btn-small" onclick="changeMonth(1)">ä¸‹æœˆ â†’</button>
                        </div>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div id="tab-rankings" class="tab-content">
            <div class="card">
                <h2 class="card-title">å‰§ç›®è§‚çœ‹æ¬¡æ•°æ’è¡Œ</h2>
                <div id="showsRanking"></div>
            </div>
            <div class="card" style="margin-top: 20px;">
                <h2 class="card-title">æ¼”å‘˜è§‚çœ‹æ¬¡æ•°æ’è¡Œ</h2>
                <div id="actorsRanking"></div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ€»ç»“ -->
        <div id="tab-summary" class="tab-content">
            <div class="card">
                <h2 class="card-title">è§‚æ¼”ç»Ÿè®¡</h2>
                <div class="stats-grid" id="statsOverall"></div>
                
                <h3 class="card-title" style="margin-top: 30px;">æœˆåº¦ç»Ÿè®¡</h3>
                <div id="monthlyStats"></div>
                
                <h3 class="card-title" style="margin-top: 30px;">å¹´åº¦ç»Ÿè®¡</h3>
                <div id="yearlyStats"></div>
            </div>
        </div>

        <!-- å‰§ç›®ä¿¡æ¯ -->
        <!-- å‰§ç›®ä¿¡æ¯ -->
        <div id="tab-showInfo" class="tab-content">
            <div class="card">
                <h2 class="card-title">å‰§ç›®ä¿¡æ¯ç®¡ç†</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <p style="color: var(--text-secondary);">ç®¡ç†å‰§ç›®çš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬æµ·æŠ¥ã€æ¼”å‡ºåœ°ç‚¹ã€è§’è‰²å’Œå¡å¸</p>
                    <button class="btn" onclick="showAddShowInfoModal()">â• æ·»åŠ å‰§ç›®ä¿¡æ¯</button>
                </div>
                <div id="showInfoList"></div>
            </div>
        </div>

        <!-- æ•°æ®ç®¡ç† -->
        <div id="tab-data" class="tab-content">
            <div class="card">
                <h2 class="card-title">æ•°æ®ç®¡ç†</h2>
                
                <!-- GitHub è‡ªåŠ¨åŒæ­¥è®¾ç½® -->
                <div style="padding: 25px; background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-radius: 12px; margin-bottom: 30px; border: 2px solid #81C784;">
                    <h3 style="font-size: 1.3em; margin-bottom: 15px; color: #2E7D32;">ğŸ”„ GitHub è‡ªåŠ¨åŒæ­¥</h3>
                    <p style="color: #1B5E20; margin-bottom: 20px; line-height: 1.8;">
                        å¯ç”¨åï¼Œæ‰€æœ‰è®°å½•å°†è‡ªåŠ¨ä¿å­˜åˆ°ä½ çš„GitHubä»“åº“ï¼Œå®ç°è·¨è®¾å¤‡è‡ªåŠ¨åŒæ­¥ã€‚åªéœ€è®¾ç½®ä¸€æ¬¡ï¼Œæ°¸ä¹…æœ‰æ•ˆï¼
                    </p>
                    
                    <div id="githubStatus" style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                        <div style="font-weight: 600; margin-bottom: 8px;">åŒæ­¥çŠ¶æ€ï¼š<span id="syncStatusText">æœªå¯ç”¨</span></div>
                        <div style="font-size: 0.9em; color: var(--text-secondary);" id="syncStatusDetail">è¯·å…ˆé…ç½®GitHub Token</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #1B5E20;">GitHub Tokenï¼ˆè®¿é—®ä»¤ç‰Œï¼‰</label>
                        <input type="password" id="githubToken" placeholder="ç²˜è´´ä½ çš„ GitHub Token (ghp_...)" 
                               style="width: 100%; padding: 12px; border: 2px solid #81C784; border-radius: 8px; font-family: monospace;">
                        <div style="font-size: 0.85em; color: #2E7D32; margin-top: 5px;">
                            Tokenå·²åŠ å¯†ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¼šæ³„éœ²
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="saveGitHubToken()" style="background: #2E7D32;">ä¿å­˜Tokenå¹¶å¯ç”¨åŒæ­¥</button>
                        <button class="btn btn-secondary" onclick="testGitHubConnection()">æµ‹è¯•è¿æ¥</button>
                        <button class="btn" onclick="manualSync()" style="background: #1976D2;">ç«‹å³åŒæ­¥</button>
                    </div>
                </div>
                
                <p style="color: var(--text-secondary); margin-bottom: 30px;">
                    é€šè¿‡å¯¼å‡ºå’Œå¯¼å…¥åŠŸèƒ½ï¼Œä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨åœ¨ä¸åŒè®¾å¤‡é—´åŒæ­¥è§‚æ¼”è®°å½•ã€‚
                </p>
                
                <div style="display: grid; gap: 20px; margin-bottom: 30px;">
                    <div style="padding: 25px; background: var(--bg-main); border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h3 style="font-size: 1.2em; margin-bottom: 12px; color: var(--primary);">ğŸ“¤ å¯¼å‡ºæ•°æ®</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95em;">
                            å°†æ‰€æœ‰è®°å½•å¯¼å‡ºä¸ºJSONæ–‡ä»¶ï¼Œå¯ä»¥ä¿å­˜åˆ°äº‘ç›˜æˆ–å‘é€åˆ°å…¶ä»–è®¾å¤‡ã€‚
                        </p>
                        <button class="btn" onclick="exportData()">å¯¼å‡ºæ‰€æœ‰è®°å½•</button>
                    </div>
                    
                    <div style="padding: 25px; background: var(--bg-main); border-radius: 12px; border-left: 4px solid var(--secondary);">
                        <h3 style="font-size: 1.2em; margin-bottom: 12px; color: var(--primary);">ğŸ“¥ å¯¼å…¥æ•°æ®</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95em;">
                            ä»ä¹‹å‰å¯¼å‡ºçš„æ–‡ä»¶ä¸­æ¢å¤è®°å½•ã€‚å¯ä»¥é€‰æ‹©è¦†ç›–å½“å‰æ•°æ®æˆ–åˆå¹¶æ•°æ®ã€‚
                        </p>
                        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">é€‰æ‹©æ–‡ä»¶å¯¼å…¥</button>
                        </div>
                    </div>
                </div>
                
                <div style="padding: 20px; background: #FFF9E6; border-radius: 12px; border: 2px solid #FFE4A3;">
                    <h3 style="font-size: 1.1em; margin-bottom: 10px; color: #8B7500;">ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                    <ul style="color: #6B5500; line-height: 1.8; margin-left: 20px;">
                        <li><strong>GitHubåŒæ­¥</strong>ï¼šå¯ç”¨åæ¯æ¬¡ä¿å­˜éƒ½ä¼šè‡ªåŠ¨ä¸Šä¼ åˆ°GitHubï¼Œå…¶ä»–è®¾å¤‡æ‰“å¼€ç½‘ç«™æ—¶è‡ªåŠ¨åŠ è½½æœ€æ–°æ•°æ®</li>
                        <li><strong>æ‰‹åŠ¨å¯¼å‡º</strong>ï¼šå®šæœŸå¯¼å‡ºæ•°æ®ä½œä¸ºå¤‡ä»½ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±</li>
                        <li>å¯¼å‡ºçš„æ–‡ä»¶å¯ä»¥ä¿å­˜åˆ°äº‘ç›˜ï¼ˆå¦‚ç™¾åº¦ç½‘ç›˜ã€iCloudç­‰ï¼‰</li>
                        <li>åœ¨æ–°è®¾å¤‡ä¸Šæ‰“å¼€ç½‘ç«™åï¼Œå¯¼å…¥ä¹‹å‰å¯¼å‡ºçš„æ–‡ä»¶å³å¯æ¢å¤æ•°æ®</li>
                        <li>å¯¼å…¥æ—¶ä¼šæç¤ºä½ é€‰æ‹©è¦†ç›–æˆ–åˆå¹¶ï¼Œåˆå¹¶æ¨¡å¼ä¼šä¿ç•™ä¸¤è¾¹çš„æ•°æ®</li>
                    </ul>
                </div>
                
                <div style="margin-top: 30px; padding: 20px; background: #FFE5E5; border-radius: 12px; border: 2px solid #FFB3B3;">
                    <h3 style="font-size: 1.1em; margin-bottom: 10px; color: #C00000;">âš ï¸ å±é™©æ“ä½œ</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px; font-size: 0.95em;">
                        æ¸…ç©ºæ‰€æœ‰æ•°æ®å°†æ— æ³•æ¢å¤ï¼Œè¯·è°¨æ…æ“ä½œã€‚å»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚
                    </p>
                    <button class="btn" onclick="clearAllData()" style="background: #dc3545;">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ç¼–è¾‘è®°å½•</h3>
                <button class="close-btn" onclick="closeEditModal()">Ã—</button>
            </div>
            <form id="editForm">
                <input type="hidden" id="editId">
                <div class="form-group">
                    <label>å‰§ç›®åç§° *</label>
                    <div style="position: relative;">
                        <input type="text" id="editShowName" required autocomplete="off">
                        <div id="editShowNameDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>å‰§ç§ *</label>
                    <input type="text" id="editShowType" required>
                </div>
                <div class="form-group">
                    <label>è§‚æ¼”æ—¥æœŸ *</label>
                    <input type="date" id="editShowDate" required>
                </div>
                <div class="form-group">
                    <label>å…·ä½“æ—¶é—´</label>
                    <input type="time" id="editShowTime">
                </div>
                <div class="form-group">
                    <label>å¡å¸</label>
                    <div class="batch-parse-section">
                        <label style="font-weight: 600; margin-bottom: 8px; display: block;">æ‰¹é‡è¯†åˆ«æ¼”å‘˜</label>
                        <textarea id="editCastBatchInput" class="batch-parse-textarea" placeholder="ç²˜è´´æ¼”å‘˜åˆ—è¡¨ï¼Œæ¯è¡Œä¸€ä¸ªæˆ–ç”¨é€—å·åˆ†éš”"></textarea>
                        <div class="batch-parse-hint">ğŸ’¡ ç²˜è´´åè‡ªåŠ¨è¯†åˆ«ï¼Œæ”¯æŒæ¢è¡Œæˆ–é€—å·åˆ†éš”</div>
                    </div>
                    <label style="font-weight: 600; margin-top: 15px; display: block;">æˆ–æ‰‹åŠ¨è¾“å…¥ï¼ˆå¤šä¸ªæ¼”å‘˜ç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="editShowCast">
                </div>
                <div class="form-group">
                    <label>åº§ä½</label>
                    <input type="text" id="editShowSeat">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea id="editShowNotes"></textarea>
                </div>
                <div class="form-group">
                    <label>ç…§ç‰‡</label>
                    <div id="editImagePreview" class="image-preview"></div>
                    <input type="file" id="editShowImages" accept="image/*" multiple class="image-upload">
                </div>
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn">ä¿å­˜ä¿®æ”¹</button>
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ—¥å†è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="dayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="dayModalTitle"></h3>
                <button class="close-btn" onclick="closeDayModal()">Ã—</button>
            </div>
            <div id="dayModalContent"></div>
        </div>
    </div>

    <!-- å‰§ç›®ä¿¡æ¯æ¨¡æ€æ¡† -->
    <div id="showInfoModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="showInfoModalTitle">æ·»åŠ å‰§ç›®ä¿¡æ¯</h3>
                <button class="close-btn" onclick="closeShowInfoModal()">Ã—</button>
            </div>
            <form id="showInfoForm">
                <input type="hidden" id="showInfoId">
                <div class="form-group">
                    <label>å‰§ç›®åç§° *</label>
                    <input type="text" id="showInfoName" required>
                </div>
                <div class="form-group">
                    <label>æ¼”å‡ºåœ°ç‚¹</label>
                    <input type="text" id="showInfoVenue" placeholder="ä¾‹å¦‚ï¼šä¸Šæµ·æ–‡åŒ–å¹¿åœº">
                </div>
                <div class="form-group">
                    <label>å‰§ç›®æµ·æŠ¥</label>
                    <input type="file" id="showInfoPoster" accept="image/*">
                    <div id="posterPreview" style="margin-top: 10px;"></div>
                </div>
                
                <div class="form-group">
                    <label>è§’è‰²ä¸å¡å¸</label>
                    <p style="font-size: 0.9em; color: var(--text-secondary); margin-bottom: 10px;">
                        ä¸ºæ¯ä¸ªè§’è‰²æ·»åŠ å¡å¸ã€‚åŒä¸€æ¼”å‘˜å¯ä»¥åœ¨å¤šä¸ªè§’è‰²ä¸­å‡ºç°ã€‚
                    </p>
                    <div id="rolesContainer"></div>
                    <button type="button" class="btn btn-secondary btn-add-small" onclick="addRoleInput()">+ æ·»åŠ è§’è‰²</button>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">ä¿å­˜å‰§ç›®ä¿¡æ¯</button>
                    <button type="button" class="btn btn-secondary" onclick="closeShowInfoModal()">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å‰§ç›®è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="showDetailModal" class="modal show-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="showDetailTitle"></h3>
                <button class="close-btn" onclick="closeShowDetailModal()">Ã—</button>
            </div>
            <div id="showDetailContent"></div>
        </div>
    </div>

    <script>
        // GitHub åŒæ­¥é…ç½®
        const GITHUB_CONFIG = {
            username: 'auriarw',
            repo: 'guanjujilu.github.io',
            branch: 'main',
            dataFile: 'show-records-data.json',
            token: '' // å°†åœ¨è®¾ç½®ä¸­é…ç½®
        };
        
        // æ•°æ®å­˜å‚¨
        let records = JSON.parse(localStorage.getItem('musicalRecords') || '[]');
        let showsInfo = JSON.parse(localStorage.getItem('showsInfo') || '[]');
        let manualWatchCounts = JSON.parse(localStorage.getItem('manualWatchCounts') || '{}');
        let currentMonth = new Date();
        let currentEditId = null;
        let tempImages = [];
        let editTempImages = [];
        let tempPoster = null;
        let isSyncing = false;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // åŠ è½½GitHubé…ç½®
            loadGitHubConfig();
            
            // å°è¯•ä»GitHubåŠ è½½æ•°æ®
            syncFromGitHub().then(() => {
                console.log('å½“å‰è®°å½•æ•°:', records.length);
                loadRecords();
                renderCalendar();
            }).catch(err => {
                console.log('GitHubåŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:', err.message);
                console.log('å½“å‰è®°å½•æ•°:', records.length);
                loadRecords();
                renderCalendar();
            });
            
            // è¡¨å•æäº¤
            const addForm = document.getElementById('addForm');
            if (addForm) {
                addForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('è¡¨å•æäº¤è¢«è§¦å‘');
                    addRecord();
                    return false;
                });
            }
            
            const editForm = document.getElementById('editForm');
            if (editForm) {
                editForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    updateRecord();
                    return false;
                });
            }
            
            // å›¾ç‰‡ä¸Šä¼ é¢„è§ˆ
            document.getElementById('showImages').addEventListener('change', handleImageUpload);
            document.getElementById('editShowImages').addEventListener('change', handleEditImageUpload);
            
            // å‰§ç›®åç§°è‡ªåŠ¨è¡¥å…¨
            setupShowNameAutocomplete('showName', 'showNameDropdown');
            setupShowNameAutocomplete('editShowName', 'editShowNameDropdown');
            
            // å¡å¸æ‰¹é‡è¯†åˆ«
            setupCastBatchParse('castBatchInput', 'showCast');
            setupCastBatchParse('editCastBatchInput', 'editShowCast');
            
            // åŠ è½½ä¿å­˜çš„tokenåˆ°è¾“å…¥æ¡†
            if (GITHUB_CONFIG.token) {
                document.getElementById('githubToken').value = GITHUB_CONFIG.token;
            }
        });


        // ============ å‰§ç›®åç§°è‡ªåŠ¨è¡¥å…¨åŠŸèƒ½ ============
        
        function setupShowNameAutocomplete(inputId, dropdownId) {
            const input = document.getElementById(inputId);
            const dropdown = document.getElementById(dropdownId);
            
            if (!input || !dropdown) return;
            
            // è¾“å…¥æ—¶æ˜¾ç¤ºå»ºè®®
            input.addEventListener('input', function() {
                const value = this.value.trim().toLowerCase();
                
                // å¦‚æœæ˜¯æ·»åŠ è®°å½•è¡¨å•ï¼Œæ›´æ–°å¡å¸é€‰æ‹©
                if (inputId === 'showName') {
                    updateCastSelection();
                }
                
                if (!value) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                // è·å–æ‰€æœ‰å”¯ä¸€çš„å‰§ç›®åç§°ï¼ˆä»è®°å½•å’Œå‰§ç›®ä¿¡æ¯ä¸­ï¼‰
                const showNames = new Set();
                records.forEach(r => showNames.add(r.showName));
                showsInfo.forEach(s => showNames.add(s.name));
                
                // è¿‡æ»¤åŒ¹é…çš„å‰§ç›®
                const matches = Array.from(showNames).filter(name => 
                    name.toLowerCase().includes(value)
                );
                
                if (matches.length === 0) {
                    dropdown.classList.remove('active');
                    return;
                }
                
                // æ˜¾ç¤ºå»ºè®®åˆ—è¡¨
                dropdown.innerHTML = matches.slice(0, 5).map(name => {
                    // é«˜äº®åŒ¹é…çš„éƒ¨åˆ†
                    const index = name.toLowerCase().indexOf(value);
                    const before = name.substring(0, index);
                    const match = name.substring(index, index + value.length);
                    const after = name.substring(index + value.length);
                    
                    return `
                        <div class="autocomplete-item" data-value="${name}">
                            ${before}<strong>${match}</strong>${after}
                        </div>
                    `;
                }).join('');
                
                dropdown.classList.add('active');
                
                // ç‚¹å‡»å»ºè®®é¡¹
                dropdown.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('click', function() {
                        input.value = this.dataset.value;
                        dropdown.classList.remove('active');
                        
                        // å¦‚æœæ˜¯æ·»åŠ è®°å½•è¡¨å•ï¼Œæ›´æ–°å¡å¸é€‰æ‹©
                        if (inputId === 'showName') {
                            updateCastSelection();
                        }
                    });
                });
            });
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                    dropdown.classList.remove('active');
                }
            });
            
            // å¤±ç„¦æ—¶å…³é—­
            input.addEventListener('blur', function() {
                setTimeout(() => dropdown.classList.remove('active'), 200);
            });
        }
        
        // ============ å¡å¸æ‰¹é‡è¯†åˆ«åŠŸèƒ½ ============
        
        function setupCastBatchParse(textareaId, targetInputId) {
            const textarea = document.getElementById(textareaId);
            const targetInput = document.getElementById(targetInputId);
            
            if (!textarea || !targetInput) return;
            
            textarea.addEventListener('input', function() {
                const text = this.value.trim();
                
                if (!text) {
                    return;
                }
                
                // è§£ææ¼”å‘˜åˆ—è¡¨
                const casts = parseCastList(text);
                
                if (casts.length > 0) {
                    // è‡ªåŠ¨å¡«å……åˆ°ç›®æ ‡è¾“å…¥æ¡†
                    targetInput.value = casts.join(', ');
                }
            });
        }
        
        function parseCastList(text) {
            // å…ˆæŒ‰æ¢è¡Œåˆ†å‰²
            let lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            // å†å¤„ç†æ¯è¡Œä¸­çš„é€—å·åˆ†éš”
            let casts = [];
            lines.forEach(line => {
                if (line.includes(',') || line.includes('ï¼Œ')) {
                    // å¦‚æœåŒ…å«é€—å·ï¼ŒæŒ‰é€—å·åˆ†å‰²
                    const parts = line.split(/[,ï¼Œ]/).map(p => p.trim()).filter(p => p);
                    casts.push(...parts);
                } else {
                    // å¦åˆ™æ•´è¡Œä½œä¸ºä¸€ä¸ªåå­—
                    casts.push(line);
                }
            });
            
            // å»é‡
            return [...new Set(casts)];
        }

        // ============ å¿«æ·é€‰æ‹©åŠŸèƒ½ ============
        
        // è®¾ç½®æ—¶é—´
        function setTime(time) {
            document.getElementById('showTime').value = time;
        }
        
        // å­˜å‚¨å½“å‰é€‰æ‹©çš„æ¼”å‘˜åŠå…¶è§’è‰²ä¿¡æ¯
        let selectedCastsWithRoles = [];
        
        // æ ¹æ®å‰§ç›®åç§°æ›´æ–°å¡å¸é€‰æ‹©
        function updateCastSelection() {
            const showName = document.getElementById('showName').value.trim();
            const castSelectionArea = document.getElementById('castSelectionArea');
            const castButtonsByRole = document.getElementById('castButtonsByRole');
            
            // æ¸…ç©ºä¹‹å‰çš„é€‰æ‹©
            selectedCastsWithRoles = [];
            
            if (!showName) {
                castSelectionArea.style.display = 'none';
                return;
            }
            
            // æŸ¥æ‰¾å¯¹åº”çš„å‰§ç›®ä¿¡æ¯
            const showInfo = showsInfo.find(s => s.name === showName);
            
            if (!showInfo || !showInfo.roles || showInfo.roles.length === 0) {
                castSelectionArea.style.display = 'none';
                return;
            }
            
            // æ˜¾ç¤ºé€‰æ‹©åŒºåŸŸ
            castSelectionArea.style.display = 'block';
            
            // æŒ‰è§’è‰²ç”ŸæˆæŒ‰é’®ç»„
            castButtonsByRole.innerHTML = showInfo.roles.map(role => {
                if (!role.casts || role.casts.length === 0) return '';
                
                return `
                    <div style="margin-bottom: 12px;">
                        <div style="font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); font-size: 0.9em;">
                            ${role.roleName}
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${role.casts.map(castName => `
                                <button type="button" 
                                        class="btn btn-small btn-secondary cast-select-btn" 
                                        data-role="${role.roleName}" 
                                        data-cast="${castName}"
                                        onclick="toggleCastSelection('${role.roleName}', '${castName}', this)">
                                    ${castName}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // åˆ‡æ¢æ¼”å‘˜é€‰æ‹©çŠ¶æ€
        function toggleCastSelection(roleName, castName, button) {
            const key = `${roleName}|||${castName}`;
            const index = selectedCastsWithRoles.findIndex(item => item.key === key);
            
            if (index >= 0) {
                // å–æ¶ˆé€‰æ‹©
                selectedCastsWithRoles.splice(index, 1);
                button.style.background = '';
                button.style.opacity = '';
            } else {
                // é€‰ä¸­
                selectedCastsWithRoles.push({
                    key: key,
                    roleName: roleName,
                    castName: castName
                });
                button.style.background = 'var(--primary)';
                button.style.opacity = '0.8';
            }
            
            // æ›´æ–°è¾“å…¥æ¡†ï¼ˆåªæ˜¾ç¤ºæ¼”å‘˜åå­—ï¼‰
            updateCastInputFromSelection();
        }
        
        // æ›´æ–°å¡å¸è¾“å…¥æ¡†
        function updateCastInputFromSelection() {
            const castNames = selectedCastsWithRoles.map(item => item.castName);
            document.getElementById('showCast').value = castNames.join(', ');
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // æ‰¾åˆ°è¢«ç‚¹å‡»çš„æ ‡ç­¾
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                const text = tab.textContent.trim();
                if (text.includes('æ·»åŠ è®°å½•') && tabName === 'add') tab.classList.add('active');
                if (text.includes('æ‰€æœ‰è®°å½•') && tabName === 'list') tab.classList.add('active');
                if (text.includes('æ—¥å†è§†å›¾') && tabName === 'calendar') tab.classList.add('active');
                if (text.includes('æ’è¡Œæ¦œ') && tabName === 'rankings') tab.classList.add('active');
                if (text.includes('ç»Ÿè®¡æ€»ç»“') && tabName === 'summary') tab.classList.add('active');
                if (text.includes('å‰§ç›®ä¿¡æ¯') && tabName === 'showInfo') tab.classList.add('active');
                if (text.includes('æ•°æ®ç®¡ç†') && tabName === 'data') tab.classList.add('active');
            });
            
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // åŠ è½½å¯¹åº”å†…å®¹
            if (tabName === 'list') loadRecords();
            if (tabName === 'calendar') renderCalendar();
            if (tabName === 'rankings') {
                renderShowsRanking();
                renderActorsRanking();
            }
            if (tabName === 'summary') renderSummary();
            if (tabName === 'showInfo') renderShowInfoList();
        }

        // å›¾ç‰‡ä¸Šä¼ å¤„ç†
        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            tempImages = [];
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    tempImages.push(event.target.result);
                    renderImagePreview('imagePreview', tempImages);
                };
                reader.readAsDataURL(file);
            });
        }

        function handleEditImageUpload(e) {
            const files = Array.from(e.target.files);
            
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    editTempImages.push(event.target.result);
                    renderImagePreview('editImagePreview', editTempImages);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderImagePreview(containerId, images) {
            const container = document.getElementById(containerId);
            container.innerHTML = images.map((img, index) => `
                <div class="image-preview-item">
                    <img src="${img}" alt="é¢„è§ˆ">
                    <button type="button" class="image-remove" onclick="removeImage('${containerId}', ${index})">Ã—</button>
                </div>
            `).join('');
        }

        function removeImage(containerId, index) {
            if (containerId === 'imagePreview') {
                tempImages.splice(index, 1);
                renderImagePreview('imagePreview', tempImages);
            } else {
                editTempImages.splice(index, 1);
                renderImagePreview('editImagePreview', editTempImages);
            }
        }

        // æ·»åŠ è®°å½•
        function addRecord() {
            console.log('addRecordå‡½æ•°è¢«è°ƒç”¨');
            
            const showName = document.getElementById('showName').value;
            const showType = document.getElementById('showType').value;
            const date = document.getElementById('showDate').value;
            
            console.log('è¡¨å•æ•°æ®:', { showName, showType, date });
            
            if (!showName || !showType || !date) {
                alert('è¯·å¡«å†™å¿…å¡«é¡¹ï¼šå‰§ç›®åç§°ã€å‰§ç§å’Œè§‚æ¼”æ—¥æœŸ');
                return;
            }
            
            const record = {
                id: Date.now(),
                showName: showName,
                showType: showType,
                date: date,
                time: document.getElementById('showTime').value,
                cast: document.getElementById('showCast').value.split(',').map(s => s.trim()).filter(s => s),
                castWithRoles: [...selectedCastsWithRoles], // ä¿å­˜å¸¦è§’è‰²ä¿¡æ¯çš„å¡å¸
                seat: document.getElementById('showSeat').value,
                notes: document.getElementById('showNotes').value,
                images: [...tempImages], // å¤åˆ¶æ•°ç»„
                createdAt: new Date().toISOString()
            };
            
            console.log('åˆ›å»ºçš„è®°å½•:', record);
            
            records.push(record);
            console.log('æ·»åŠ åæ€»è®°å½•æ•°:', records.length);
            
            saveRecords();
            console.log('ä¿å­˜åˆ°localStorageå®Œæˆ');
            
            // é‡ç½®è¡¨å•å’Œå›¾ç‰‡
            document.getElementById('addForm').reset();
            tempImages = [];
            selectedCastsWithRoles = [];
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('castSelectionArea').style.display = 'none';
            
            alert('è®°å½•æ·»åŠ æˆåŠŸï¼\nå·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨\nå½“å‰å…±æœ‰ ' + records.length + ' æ¡è®°å½•');
            
            // ä¿æŒåœ¨æ·»åŠ è®°å½•é¡µé¢ï¼Œä¸è·³è½¬
        }

        // åŠ è½½è®°å½•åˆ—è¡¨
        function loadRecords() {
            const container = document.getElementById('recordsList');
            
            if (records.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ­</div>
                        <p>è¿˜æ²¡æœ‰è§‚æ¼”è®°å½•ï¼Œå¿«å»æ·»åŠ ç¬¬ä¸€æ¡è®°å½•å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¥æœŸæ’åºï¼ˆå­—ç¬¦ä¸²æ¯”è¾ƒå³å¯ï¼Œå› ä¸ºæ˜¯YYYY-MM-DDæ ¼å¼ï¼‰
            const sortedRecords = [...records].sort((a, b) => {
                // å…ˆæŒ‰æ—¥æœŸæ’åº
                const dateCompare = b.date.localeCompare(a.date);
                if (dateCompare !== 0) return dateCompare;
                // æ—¥æœŸç›¸åŒåˆ™æŒ‰æ—¶é—´æ’åº
                if (a.time && b.time) {
                    return b.time.localeCompare(a.time);
                }
                return 0;
            });
            
            container.innerHTML = sortedRecords.map(record => `
                <div class="record-item">
                    <div class="record-header">
                        <div>
                            <div class="record-title">${record.showName}</div>
                            <span class="record-type">${record.showType}</span>
                        </div>
                    </div>
                    <div class="record-details">
                        <div class="record-detail">ğŸ“… ${formatDate(record.date)}</div>
                        ${record.time ? `<div class="record-detail">â° ${record.time}</div>` : ''}
                        ${record.seat ? `<div class="record-detail">ğŸ’º ${record.seat}</div>` : ''}
                        ${record.cast.length > 0 ? `<div class="record-detail">â­ ${record.cast.join(', ')}</div>` : ''}
                    </div>
                    ${record.notes ? `<div style="margin-top: 12px; color: var(--text-secondary);">${record.notes}</div>` : ''}
                    ${record.images && record.images.length > 0 ? `
                        <div class="image-preview" style="margin-top: 12px;">
                            ${record.images.map(img => `
                                <div class="image-preview-item">
                                    <img src="${img}" alt="æ¼”å‡ºç…§ç‰‡">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="record-actions">
                        <button class="btn btn-small btn-secondary" onclick="editRecord(${record.id})">ç¼–è¾‘</button>
                        <button class="btn btn-small" onclick="deleteRecord(${record.id})" style="background: #dc3545;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ç¼–è¾‘è®°å½•
        function editRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;
            
            currentEditId = id;
            editTempImages = record.images || [];
            
            document.getElementById('editId').value = record.id;
            document.getElementById('editShowName').value = record.showName;
            document.getElementById('editShowType').value = record.showType;
            document.getElementById('editShowDate').value = record.date;
            document.getElementById('editShowTime').value = record.time || '';
            document.getElementById('editShowCast').value = record.cast.join(', ');
            document.getElementById('editShowSeat').value = record.seat || '';
            document.getElementById('editShowNotes').value = record.notes || '';
            
            renderImagePreview('editImagePreview', editTempImages);
            
            document.getElementById('editModal').classList.add('active');
        }

        // æ›´æ–°è®°å½•
        function updateRecord() {
            const id = parseInt(document.getElementById('editId').value);
            const index = records.findIndex(r => r.id === id);
            
            if (index !== -1) {
                records[index] = {
                    ...records[index],
                    showName: document.getElementById('editShowName').value,
                    showType: document.getElementById('editShowType').value,
                    date: document.getElementById('editShowDate').value,
                    time: document.getElementById('editShowTime').value,
                    cast: document.getElementById('editShowCast').value.split(',').map(s => s.trim()).filter(s => s),
                    seat: document.getElementById('editShowSeat').value,
                    notes: document.getElementById('editShowNotes').value,
                    images: editTempImages
                };
                
                saveRecords();
                closeEditModal();
                alert('è®°å½•æ›´æ–°æˆåŠŸï¼');
                
                // åˆ·æ–°å½“å‰è§†å›¾
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'tab-list') {
                    loadRecords();
                } else if (activeTab.id === 'tab-calendar') {
                    renderCalendar();
                }
            }
        }

        // åˆ é™¤è®°å½•
        function deleteRecord(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
                records = records.filter(r => r.id !== id);
                saveRecords();
                
                // åˆ·æ–°å½“å‰è§†å›¾
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab.id === 'tab-list') {
                    loadRecords();
                } else if (activeTab.id === 'tab-calendar') {
                    renderCalendar();
                }
            }
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditId = null;
            editTempImages = [];
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // æ˜ŸæœŸæ ‡é¢˜
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // ä¸Šæœˆæ—¥æœŸ
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = daysInPrevMonth - i;
                const dayEl = createCalendarDay(day, year, month - 1, true);
                grid.appendChild(dayEl);
            }
            
            // å½“æœˆæ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = createCalendarDay(day, year, month, false);
                grid.appendChild(dayEl);
            }
            
            // ä¸‹æœˆæ—¥æœŸ
            const remainingDays = 42 - (firstDay + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                const dayEl = createCalendarDay(day, year, month + 1, true);
                grid.appendChild(dayEl);
            }
        }

        function createCalendarDay(day, year, month, isOtherMonth) {
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            let dayRecords = records.filter(r => r.date === dateStr);
            
            // æŒ‰æ—¶é—´æ’åº
            dayRecords.sort((a, b) => {
                if (!a.time && !b.time) return 0;
                if (!a.time) return 1;
                if (!b.time) return -1;
                return a.time.localeCompare(b.time);
            });
            
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            if (isOtherMonth) dayEl.classList.add('other-month');
            if (dayRecords.length > 0) dayEl.classList.add('has-show');
            
            // ä¸ºæ¯æ¡è®°å½•è·å–å‰§ç›®æµ·æŠ¥ï¼ˆåªä½¿ç”¨å‰§ç›®ä¿¡æ¯ä¸­çš„æµ·æŠ¥ï¼‰
            const recordsWithImages = dayRecords.map(record => {
                // æŸ¥æ‰¾å¯¹åº”çš„å‰§ç›®ä¿¡æ¯
                const showInfo = showsInfo.find(s => s.name === record.showName);
                let image = null;
                
                // åªä½¿ç”¨å‰§ç›®æµ·æŠ¥
                if (showInfo && showInfo.poster) {
                    image = showInfo.poster;
                }
                
                return {
                    record: record,
                    image: image
                };
            }).filter(item => item.image); // åªä¿ç•™æœ‰æµ·æŠ¥çš„
            
            let contentHtml = '';
            
            if (recordsWithImages.length > 0) {
                // å¦‚æœæœ‰æµ·æŠ¥ï¼ŒæŒ‰æ—¶é—´é¡ºåºä¸Šä¸‹æ’åˆ—æ‰€æœ‰æœ‰æµ·æŠ¥çš„è®°å½•
                contentHtml = recordsWithImages.map(item => `
                    <div class="day-image-split">
                        <img src="${item.image}" alt="${item.record.showName}">
                        <div class="day-image-overlay">${item.record.showName}${item.record.time ? ' ' + item.record.time : ''}</div>
                    </div>
                `).join('');
            } else {
                // å¦‚æœæ²¡æœ‰æµ·æŠ¥ï¼Œåªæ˜¾ç¤ºå‰§å
                contentHtml = `
                    <div class="day-text-only">
                        ${dayRecords.map(record => `
                            <div class="day-text-item">${record.showName}</div>
                        `).join('')}
                    </div>
                `;
            }
            
            dayEl.innerHTML = `
                <div class="day-number">${day}</div>
                <div class="day-content">
                    ${contentHtml}
                </div>
            `;
            
            if (dayRecords.length > 0) {
                dayEl.onclick = () => showDayDetail(dateStr, dayRecords);
            }
            
            return dayEl;
        }

        function showDayDetail(date, dayRecords) {
            document.getElementById('dayModalTitle').textContent = formatDate(date);
            document.getElementById('dayModalContent').innerHTML = dayRecords.map(record => `
                <div class="record-item" style="margin-bottom: 15px;">
                    <div class="record-title">${record.showName}</div>
                    <div class="record-type">${record.showType}</div>
                    ${record.time ? `<div style="margin-top: 8px;">â° ${record.time}</div>` : ''}
                    ${record.cast.length > 0 ? `<div style="margin-top: 4px;">â­ ${record.cast.join(', ')}</div>` : ''}
                    ${record.seat ? `<div style="margin-top: 4px;">ğŸ’º ${record.seat}</div>` : ''}
                    ${record.notes ? `<div style="margin-top: 8px; color: var(--text-secondary);">${record.notes}</div>` : ''}
                    ${record.images && record.images.length > 0 ? `
                        <div class="image-preview" style="margin-top: 10px;">
                            ${record.images.map(img => `
                                <div class="image-preview-item" style="width: 120px; height: 120px;">
                                    <img src="${img}" alt="æ¼”å‡ºç…§ç‰‡">
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
            document.getElementById('dayModal').classList.add('active');
        }

        function closeDayModal() {
            document.getElementById('dayModal').classList.remove('active');
        }

        function changeMonth(delta) {
            currentMonth.setMonth(currentMonth.getMonth() + delta);
            renderCalendar();
        }

        function goToToday() {
            currentMonth = new Date();
            renderCalendar();
        }

        // å‰§ç›®æ’è¡Œ
        function renderShowsRanking() {
            const showCounts = {};
            records.forEach(record => {
                showCounts[record.showName] = (showCounts[record.showName] || 0) + 1;
            });
            
            const sorted = Object.entries(showCounts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('showsRanking');
            
            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ­</div>
                        <p>æš‚æ— å‰§ç›®æ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sorted.map(([name, count], index) => `
                <div class="ranking-item">
                    <div class="ranking-number ${index < 3 ? 'top' : ''}">${index + 1}</div>
                    <div class="ranking-name">${name}</div>
                    <div class="ranking-count">${count} æ¬¡</div>
                </div>
            `).join('');
        }

        // æ¼”å‘˜æ’è¡Œ
        function renderActorsRanking() {
            const actorCounts = {};
            records.forEach(record => {
                record.cast.forEach(actor => {
                    if (actor) {
                        actorCounts[actor] = (actorCounts[actor] || 0) + 1;
                    }
                });
            });
            
            const sorted = Object.entries(actorCounts).sort((a, b) => b[1] - a[1]);
            const container = document.getElementById('actorsRanking');
            
            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">â­</div>
                        <p>æš‚æ— æ¼”å‘˜æ•°æ®</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sorted.map(([name, count], index) => `
                <div class="ranking-item">
                    <div class="ranking-number ${index < 3 ? 'top' : ''}">${index + 1}</div>
                    <div class="ranking-name">${name}</div>
                    <div class="ranking-count">${count} æ¬¡</div>
                </div>
            `).join('');
        }

        // ç»Ÿè®¡æ€»ç»“
        function renderSummary() {
            // æ€»ä½“ç»Ÿè®¡
            const totalShows = records.length;
            const uniqueShows = new Set(records.map(r => r.showName)).size;
            const uniqueActors = new Set(records.flatMap(r => r.cast)).size;
            
            document.getElementById('statsOverall').innerHTML = `
                <div class="stat-card">
                    <span class="stat-number">${totalShows}</span>
                    <span class="stat-label">æ€»è§‚æ¼”åœºæ¬¡</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${uniqueShows}</span>
                    <span class="stat-label">ä¸åŒå‰§ç›®</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number">${uniqueActors}</span>
                    <span class="stat-label">ä¸åŒæ¼”å‘˜</span>
                </div>
            `;
            
            // æœˆåº¦ç»Ÿè®¡
            const monthlyData = {};
            records.forEach(record => {
                const month = record.date.substring(0, 7);
                monthlyData[month] = (monthlyData[month] || 0) + 1;
            });
            
            const sortedMonths = Object.entries(monthlyData).sort((a, b) => b[0].localeCompare(a[0]));
            document.getElementById('monthlyStats').innerHTML = sortedMonths.map(([month, count]) => `
                <div class="ranking-item">
                    <div class="ranking-name">${month}</div>
                    <div class="ranking-count">${count} åœº</div>
                </div>
            `).join('');
            
            // å¹´åº¦ç»Ÿè®¡
            const yearlyData = {};
            records.forEach(record => {
                const year = record.date.substring(0, 4);
                yearlyData[year] = (yearlyData[year] || 0) + 1;
            });
            
            const sortedYears = Object.entries(yearlyData).sort((a, b) => b[0].localeCompare(a[0]));
            document.getElementById('yearlyStats').innerHTML = sortedYears.map(([year, count]) => `
                <div class="ranking-item">
                    <div class="ranking-name">${year}å¹´</div>
                    <div class="ranking-count">${count} åœº</div>
                </div>
            `).join('');
        }

        // å·¥å…·å‡½æ•°
        function formatDate(dateStr) {
            // ç›´æ¥è§£æYYYY-MM-DDæ ¼å¼ï¼Œé¿å…æ—¶åŒºé—®é¢˜
            const parts = dateStr.split('-');
            if (parts.length === 3) {
                const year = parts[0];
                const month = parseInt(parts[1], 10);
                const day = parseInt(parts[2], 10);
                return `${year}å¹´${month}æœˆ${day}æ—¥`;
            }
            return dateStr;
        }

        function saveRecords() {
            try {
                const dataStr = JSON.stringify(records);
                localStorage.setItem('musicalRecords', dataStr);
                console.log('æ•°æ®å·²ä¿å­˜åˆ°localStorageï¼Œå…±', records.length, 'æ¡è®°å½•');
                
                // å¦‚æœå¯ç”¨äº†GitHubåŒæ­¥ï¼Œè‡ªåŠ¨ä¸Šä¼ 
                if (GITHUB_CONFIG.token && !isSyncing) {
                    syncToGitHub().catch(err => {
                        console.error('GitHubåŒæ­¥å¤±è´¥:', err);
                    });
                }
                
                return true;
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return false;
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (records.length === 0) {
                alert('å½“å‰æ²¡æœ‰ä»»ä½•è®°å½•å¯ä»¥å¯¼å‡º');
                return;
            }
            
            const exportData = {
                records: records,
                showsInfo: showsInfo,
                manualWatchCounts: manualWatchCounts
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            
            // ä½¿ç”¨å½“å‰æ—¥æœŸä½œä¸ºæ–‡ä»¶å
            const date = new Date();
            const fileName = `è§‚æ¼”è®°å½•_${date.getFullYear()}${String(date.getMonth() + 1).padStart(2, '0')}${String(date.getDate()).padStart(2, '0')}.json`;
            link.download = fileName;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`æ•°æ®å¯¼å‡ºæˆåŠŸï¼\nå…±å¯¼å‡º ${records.length} æ¡è®°å½•`);
        }

        // å¤„ç†å¯¼å…¥æ–‡ä»¶
        function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    // é‡ç½®åŒæ­¥æ ‡å¿—ï¼Œä»¥é˜²ä¹‹å‰åŒæ­¥å¡ä½
                    isSyncing = false;
                    
                    const importedData = JSON.parse(e.target.result);
                    
                    // åˆ¤æ–­æ˜¯æ–°æ ¼å¼è¿˜æ˜¯æ—§æ ¼å¼
                    let importedRecords, importedShowsInfo, importedManualCounts;
                    
                    if (Array.isArray(importedData)) {
                        // æ—§æ ¼å¼ï¼šåªæœ‰recordsæ•°ç»„
                        importedRecords = importedData;
                        importedShowsInfo = [];
                        importedManualCounts = {};
                    } else if (importedData.records && Array.isArray(importedData.records)) {
                        // æ–°æ ¼å¼ï¼šåŒ…å«records, showsInfo, manualWatchCounts
                        importedRecords = importedData.records;
                        importedShowsInfo = importedData.showsInfo || [];
                        importedManualCounts = importedData.manualWatchCounts || {};
                    } else {
                        alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æ­£ç¡®çš„å¯¼å‡ºæ–‡ä»¶');
                        return;
                    }
                    
                    // è¯¢é—®ç”¨æˆ·æ˜¯è¦†ç›–è¿˜æ˜¯åˆå¹¶
                    const action = confirm(
                        `æ£€æµ‹åˆ° ${importedRecords.length} æ¡è®°å½•ï¼Œ${importedShowsInfo.length} ä¸ªå‰§ç›®ä¿¡æ¯\n\n` +
                        `å½“å‰æœ‰ ${records.length} æ¡è®°å½•ï¼Œ${showsInfo.length} ä¸ªå‰§ç›®ä¿¡æ¯\n\n` +
                        `ç‚¹å‡»"ç¡®å®š"åˆå¹¶æ•°æ®ï¼ˆä¿ç•™ç°æœ‰è®°å½•ï¼‰\n` +
                        `ç‚¹å‡»"å–æ¶ˆ"è¦†ç›–æ•°æ®ï¼ˆæ›¿æ¢æ‰€æœ‰è®°å½•ï¼‰`
                    );
                    
                    if (action) {
                        // åˆå¹¶æ•°æ®
                        const existingRecordIds = new Set(records.map(r => r.id));
                        const newRecords = importedRecords.filter(r => !existingRecordIds.has(r.id));
                        records = [...records, ...newRecords];
                        
                        const existingShowIds = new Set(showsInfo.map(s => s.id));
                        const newShows = importedShowsInfo.filter(s => !existingShowIds.has(s.id));
                        showsInfo = [...showsInfo, ...newShows];
                        
                        // åˆå¹¶æ‰‹åŠ¨æ¬¡æ•°è®°å½•
                        manualWatchCounts = { ...manualWatchCounts, ...importedManualCounts };
                        
                        alert(`å¯¼å…¥æˆåŠŸï¼\næ–°å¢ ${newRecords.length} æ¡è®°å½•\næ–°å¢ ${newShows.length} ä¸ªå‰§ç›®ä¿¡æ¯\næ€»è®¡ ${records.length} æ¡è®°å½•`);
                    } else {
                        // è¦†ç›–æ•°æ®
                        if (confirm('ç¡®å®šè¦è¦†ç›–æ‰€æœ‰ç°æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼')) {
                            records = importedRecords;
                            showsInfo = importedShowsInfo;
                            manualWatchCounts = importedManualCounts;
                            alert(`å¯¼å…¥æˆåŠŸï¼\nå·²è¦†ç›–ä¸º ${records.length} æ¡è®°å½•\n${showsInfo.length} ä¸ªå‰§ç›®ä¿¡æ¯`);
                        } else {
                            return;
                        }
                    }
                    
                    // ä¿å­˜åˆ°localStorageï¼ˆä¸è§¦å‘è‡ªåŠ¨åŒæ­¥ï¼‰
                    localStorage.setItem('musicalRecords', JSON.stringify(records));
                    localStorage.setItem('showsInfo', JSON.stringify(showsInfo));
                    localStorage.setItem('manualWatchCounts', JSON.stringify(manualWatchCounts));
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    loadRecords();
                    renderShowInfoList();
                    
                    // å¯¼å…¥å®Œæˆåç»Ÿä¸€åŒæ­¥ä¸€æ¬¡
                    if (GITHUB_CONFIG.token) {
                        console.log('å¯¼å…¥å®Œæˆï¼Œå¼€å§‹åŒæ­¥åˆ°GitHub...');
                        syncToGitHub().then(() => {
                            console.log('å¯¼å…¥çš„æ•°æ®å·²åŒæ­¥åˆ°GitHub');
                            alert('æ•°æ®å·²å¯¼å…¥å¹¶åŒæ­¥åˆ°GitHubï¼');
                        }).catch(err => {
                            console.error('åŒæ­¥å¤±è´¥:', err);
                            alert('æ•°æ®å·²å¯¼å…¥åˆ°æœ¬åœ°ï¼Œä½†åŒæ­¥åˆ°GitHubå¤±è´¥ï¼š' + err.message);
                        });
                    }
                    
                } catch (error) {
                    alert('æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿é€‰æ‹©çš„æ˜¯æ­£ç¡®çš„å¯¼å‡ºæ–‡ä»¶');
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
        }

        
        // ============ å‰§ç›®ä¿¡æ¯ç®¡ç†åŠŸèƒ½ ============
        
        // ä¿å­˜å‰§ç›®ä¿¡æ¯åˆ°localStorage
        function saveShowsInfo() {
            localStorage.setItem('showsInfo', JSON.stringify(showsInfo));
            // åŒæ­¥åˆ°GitHub
            syncToGitHub().catch(err => console.error('åŒæ­¥å¤±è´¥:', err));
        }
        
        // æ¸²æŸ“å‰§ç›®ä¿¡æ¯åˆ—è¡¨ï¼ˆå¡ç‰‡è§†å›¾ï¼‰
        // æ¸²æŸ“å‰§ç›®ä¿¡æ¯åˆ—è¡¨
        function renderShowInfoList() {
            const container = document.getElementById('showInfoList');
            
            if (showsInfo.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ­</div>
                        <p>è¿˜æ²¡æœ‰æ·»åŠ å‰§ç›®ä¿¡æ¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ç¬¬ä¸€ä¸ªå‰§ç›®å§ï¼</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="show-grid">
                    ${showsInfo.map(show => {
                        const watchStats = getShowWatchStats(show);
                        return `
                            <div class="show-grid-item" onclick="showShowDetailModal(${show.id})">
                                ${show.poster ? 
                                    `<img src="${show.poster}" class="show-grid-poster" alt="${show.name}">` : 
                                    `<div class="show-grid-poster" style="display: flex; align-items: center; justify-content: center; color: var(--text-secondary); background: var(--bg-main);">æš‚æ— æµ·æŠ¥</div>`
                                }
                                <div class="show-grid-info">
                                    <div class="show-grid-name" title="${show.name}">${show.name}</div>
                                    <div class="show-grid-stats">å·²è§‚çœ‹ ${watchStats.totalWatches} æ¬¡</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // æ˜¾ç¤ºå‰§ç›®è¯¦æƒ…æ¨¡æ€æ¡†
        function showShowDetailModal(showId) {
            const show = showsInfo.find(s => s.id === showId);
            if (!show) return;
            
            // è®¡ç®—è§£é”è¿›åº¦ï¼ˆæŒ‰è§’è‰²æ•°é‡è®¡ç®—ï¼‰
            const unlockStats = calculateUnlockStats(show);
            const unlockPercentage = unlockStats.total > 0 ? (unlockStats.unlocked / unlockStats.total * 100) : 0;
            
            const watchStats = getShowWatchStats(show);
            
            document.getElementById('showDetailTitle').textContent = show.name;
            document.getElementById('showDetailContent').innerHTML = `
                <div style="display: flex; gap: 30px; flex-wrap: wrap; margin-bottom: 30px;">
                    ${show.poster ? `
                        <div>
                            <img src="${show.poster}" class="show-poster" alt="${show.name}">
                        </div>
                    ` : ''}
                    <div style="flex: 1; min-width: 300px;">
                        ${show.venue ? `<p style="color: var(--text-secondary); font-size: 1.1em; margin-bottom: 10px;">ğŸ“ ${show.venue}</p>` : ''}
                        <p style="color: var(--text-secondary); font-size: 1.1em; margin-bottom: 20px;">
                            å·²è§‚çœ‹ <strong style="color: var(--primary); font-size: 1.3em;">${watchStats.totalWatches}</strong> æ¬¡
                        </p>
                        
                        <div class="unlock-progress">
                            <span>å¡å¸è§£é”</span>
                            <div class="unlock-progress-bar">
                                <div class="unlock-progress-fill" style="width: ${unlockPercentage}%"></div>
                            </div>
                            <span>${unlockStats.unlocked} / ${unlockStats.total}</span>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-small btn-secondary" onclick="closeShowDetailModal(); editShowInfo(${show.id})">ç¼–è¾‘</button>
                            <button class="btn btn-small" onclick="if(confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')){deleteShowInfo(${show.id}); closeShowDetailModal();}" style="background: #dc3545;">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
                
                ${show.roles && show.roles.length > 0 ? `
                    <div>
                        <h3 class="card-title">
                            è§’è‰²ä¸å¡å¸
                            <span style="font-size: 0.7em; color: var(--text-secondary); margin-left: 10px;">ğŸ’¡ ç‚¹å‡»å¡å¸æ¡†å¯è°ƒæ•´è§‚çœ‹æ¬¡æ•°</span>
                        </h3>
                        ${show.roles.map(role => {
                            const roleCasts = role.casts || [];
                            return `
                                <div class="role-section">
                                    <div class="role-title">${role.roleName}</div>
                                    <div class="cast-list">
                                        ${roleCasts.map(castName => {
                                            const castStats = getCastWatchStatsWithManual(show.name, role.roleName, castName);
                                            return `
                                                <div class="cast-badge ${castStats.count > 0 ? 'watched' : ''}" 
                                                     onclick="editCastWatchCount('${show.name.replace(/'/g, "\\'")}', '${role.roleName.replace(/'/g, "\\'")}', '${castName.replace(/'/g, "\\'")}', ${show.id})"
                                                     style="cursor: pointer;"
                                                     title="ç‚¹å‡»è°ƒæ•´è§‚çœ‹æ¬¡æ•°">
                                                    ${castName}
                                                    ${castStats.count > 0 ? `<span class="cast-badge-count">${castStats.count}</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<p style="color: var(--text-secondary); margin-top: 20px;">æš‚æ— è§’è‰²ä¿¡æ¯</p>'}
            `;
            
            document.getElementById('showDetailModal').classList.add('active');
        }
        
        // å…³é—­å‰§ç›®è¯¦æƒ…æ¨¡æ€æ¡†
        function closeShowDetailModal() {
            document.getElementById('showDetailModal').classList.remove('active');
        }
        
        // è®¡ç®—è§£é”ç»Ÿè®¡ï¼ˆæŒ‰è§’è‰²è®¡ç®—ï¼Œä¸€ä¸ªæ¼”å‘˜æ¼”å¤šä¸ªè§’è‰²ç®—å¤šæ¬¡ï¼‰
        function calculateUnlockStats(show) {
            if (!show.roles || show.roles.length === 0) {
                return { unlocked: 0, total: 0 };
            }
            
            let total = 0;
            let unlocked = 0;
            
            show.roles.forEach(role => {
                if (role.casts && role.casts.length > 0) {
                    role.casts.forEach(castName => {
                        total++; // æ¯ä¸ªè§’è‰²-æ¼”å‘˜ç»„åˆç®—ä¸€ä¸ª
                        const stats = getCastWatchStatsWithManual(show.name, role.roleName, castName);
                        if (stats.count > 0) {
                            unlocked++;
                        }
                    });
                }
            });
            
            return { unlocked, total };
        }
        
        // è·å–å‰§ç›®è§‚çœ‹ç»Ÿè®¡
        function getShowWatchStats(show) {
            const watches = records.filter(r => r.showName === show.name);
            return {
                totalWatches: watches.length
            };
        }
        
        // è·å–å¡å¸è§‚çœ‹ç»Ÿè®¡ï¼ˆåœ¨ç‰¹å®šå‰§ç›®çš„ç‰¹å®šè§’è‰²ä¸­ï¼‰
        function getCastWatchStats(showName, roleName, castName) {
            const watches = records.filter(r => {
                if (r.showName !== showName) return false;
                
                // ä¼˜å…ˆæ£€æŸ¥castWithRolesï¼ˆå¸¦è§’è‰²ä¿¡æ¯çš„è®°å½•ï¼‰
                if (r.castWithRoles && r.castWithRoles.length > 0) {
                    const key = `${roleName}|||${castName}`;
                    return r.castWithRoles.some(item => item.key === key);
                }
                
                // å¦‚æœæ²¡æœ‰castWithRolesï¼Œå›é€€åˆ°æ£€æŸ¥caståˆ—è¡¨ï¼ˆæ—§è®°å½•å…¼å®¹ï¼‰
                return r.cast && r.cast.some(c => c.trim() === castName.trim());
            });
            
            return {
                count: watches.length
            };
        }
        
        // è·å–å¡å¸è§‚çœ‹ç»Ÿè®¡ï¼ˆåŒ…å«æ‰‹åŠ¨è°ƒæ•´ï¼‰
        function getCastWatchStatsWithManual(showName, roleName, castName) {
            const key = `${showName}|||${roleName}|||${castName}`;
            
            // å¦‚æœæœ‰æ‰‹åŠ¨è®¾ç½®ï¼Œä½¿ç”¨æ‰‹åŠ¨å€¼
            if (manualWatchCounts[key] !== undefined) {
                return {
                    count: manualWatchCounts[key]
                };
            }
            
            // å¦åˆ™ä½¿ç”¨è‡ªåŠ¨ç»Ÿè®¡
            return getCastWatchStats(showName, roleName, castName);
        }
        
        // ä¿å­˜æ‰‹åŠ¨è§‚çœ‹æ¬¡æ•°
        function saveManualWatchCounts() {
            localStorage.setItem('manualWatchCounts', JSON.stringify(manualWatchCounts));
            // åŒæ­¥åˆ°GitHub
            syncToGitHub().catch(err => console.error('åŒæ­¥å¤±è´¥:', err));
        }
        
        // ç¼–è¾‘å¡å¸è§‚çœ‹æ¬¡æ•°
        function editCastWatchCount(showName, roleName, castName, showId) {
            const currentStats = getCastWatchStatsWithManual(showName, roleName, castName);
            const autoStats = getCastWatchStats(showName, roleName, castName);
            
            const message = `è°ƒæ•´ã€Œ${castName}ã€åœ¨ã€Œ${roleName}ã€ä¸­çš„è§‚çœ‹æ¬¡æ•°ï¼š\n\n` +
                          `å½“å‰æ˜¾ç¤ºï¼š${currentStats.count} æ¬¡\n` +
                          `è®°å½•ç»Ÿè®¡ï¼š${autoStats.count} æ¬¡\n\n` +
                          `è¯·è¾“å…¥æ–°çš„æ¬¡æ•°ï¼ˆè¾“å…¥ -1 æ¢å¤è‡ªåŠ¨ç»Ÿè®¡ï¼‰ï¼š`;
            
            const input = prompt(message, currentStats.count);
            
            if (input === null) return; // å–æ¶ˆ
            
            const newCount = parseInt(input);
            
            if (isNaN(newCount)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ•°å­—');
                return;
            }
            
            const key = `${showName}|||${roleName}|||${castName}`;
            
            if (newCount === -1) {
                // åˆ é™¤æ‰‹åŠ¨è®¾ç½®ï¼Œæ¢å¤è‡ªåŠ¨ç»Ÿè®¡
                delete manualWatchCounts[key];
                alert(`å·²æ¢å¤ä¸ºè‡ªåŠ¨ç»Ÿè®¡ï¼ˆ${autoStats.count} æ¬¡ï¼‰`);
            } else if (newCount < 0) {
                alert('æ¬¡æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                return;
            } else {
                // è®¾ç½®æ‰‹åŠ¨æ¬¡æ•°
                manualWatchCounts[key] = newCount;
                alert(`å·²è®¾ç½®ä¸º ${newCount} æ¬¡`);
            }
            
            saveManualWatchCounts();
            
            // åˆ·æ–°æ˜¾ç¤º
            showShowDetailModal(showId);
        }
        
        // æ˜¾ç¤ºæ·»åŠ å‰§ç›®ä¿¡æ¯æ¨¡æ€æ¡†
        function showAddShowInfoModal() {
            document.getElementById('showInfoModalTitle').textContent = 'æ·»åŠ å‰§ç›®ä¿¡æ¯';
            document.getElementById('showInfoForm').reset();
            document.getElementById('showInfoId').value = '';
            document.getElementById('posterPreview').innerHTML = '';
            document.getElementById('rolesContainer').innerHTML = '';
            tempPoster = null;
            
            // æ·»åŠ ä¸€ä¸ªé»˜è®¤è§’è‰²è¾“å…¥
            addRoleInput();
            
            document.getElementById('showInfoModal').classList.add('active');
        }
        
        // æ·»åŠ è§’è‰²è¾“å…¥ç»„
        let roleInputCounter = 0;
        function addRoleInput() {
            const container = document.getElementById('rolesContainer');
            const roleId = roleInputCounter++;
            
            const roleDiv = document.createElement('div');
            roleDiv.className = 'role-input-group';
            roleDiv.id = `role-${roleId}`;
            roleDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <input type="text" placeholder="è§’è‰²åç§°ï¼ˆä¾‹å¦‚ï¼šElphabaï¼‰" 
                           class="role-name-input" style="flex: 1; margin-right: 10px;">
                    <button type="button" class="btn-remove" onclick="removeRole(${roleId})">åˆ é™¤è§’è‰²</button>
                </div>
                
                <div class="batch-parse-section" style="margin-bottom: 10px;">
                    <label style="font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9em;">æ‰¹é‡æ·»åŠ æ¼”å‘˜</label>
                    <textarea id="role-batch-${roleId}" class="batch-parse-textarea" 
                              style="min-height: 60px; font-size: 0.9em;"
                              placeholder="ç²˜è´´æ¼”å‘˜åˆ—è¡¨&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
                    <button type="button" class="btn btn-secondary btn-add-small" 
                            onclick="parseBatchCastsForRole(${roleId})" 
                            style="margin-top: 5px;">
                        âœ“ è¯†åˆ«å¹¶æ·»åŠ 
                    </button>
                </div>
                
                <div class="casts-container" id="casts-${roleId}">
                    <div class="cast-input-row">
                        <input type="text" placeholder="æ¼”å‘˜åå­—" class="cast-input">
                        <button type="button" class="btn btn-secondary btn-add-small" onclick="addCastInput(${roleId})">+ æ¼”å‘˜</button>
                    </div>
                </div>
            `;
            
            container.appendChild(roleDiv);
        }
        
        // æ·»åŠ æ¼”å‘˜è¾“å…¥
        function addCastInput(roleId) {
            const container = document.getElementById(`casts-${roleId}`);
            const inputRow = document.createElement('div');
            inputRow.className = 'cast-input-row';
            inputRow.innerHTML = `
                <input type="text" placeholder="æ¼”å‘˜åå­—" class="cast-input">
                <button type="button" class="btn-remove" onclick="this.parentElement.remove()">åˆ é™¤</button>
            `;
            container.appendChild(inputRow);
        }
        
        
        // æ‰¹é‡è¯†åˆ«è§’è‰²çš„å¡å¸
        function parseBatchCastsForRole(roleId) {
            const textarea = document.getElementById(`role-batch-${roleId}`);
            const container = document.getElementById(`casts-${roleId}`);
            
            if (!textarea || !container) return;
            
            const text = textarea.value.trim();
            if (!text) {
                alert('è¯·å…ˆè¾“å…¥æ¼”å‘˜åˆ—è¡¨');
                return;
            }
            
            // è§£ææ¼”å‘˜åˆ—è¡¨
            const casts = parseCastList(text);
            
            if (casts.length === 0) {
                alert('æœªè¯†åˆ«åˆ°æ¼”å‘˜åå­—');
                return;
            }
            
            // æ¸…ç©ºç°æœ‰è¾“å…¥æ¡†
            container.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªæ¼”å‘˜åˆ›å»ºè¾“å…¥æ¡†
            casts.forEach((castName, index) => {
                const inputRow = document.createElement('div');
                inputRow.className = 'cast-input-row';
                
                if (index === 0) {
                    inputRow.innerHTML = `
                        <input type="text" placeholder="æ¼”å‘˜åå­—" class="cast-input" value="${castName}">
                        <button type="button" class="btn btn-secondary btn-add-small" onclick="addCastInput(${roleId})">+ æ¼”å‘˜</button>
                    `;
                } else {
                    inputRow.innerHTML = `
                        <input type="text" placeholder="æ¼”å‘˜åå­—" class="cast-input" value="${castName}">
                        <button type="button" class="btn-remove" onclick="this.parentElement.remove()">åˆ é™¤</button>
                    `;
                }
                
                container.appendChild(inputRow);
            });
            
            // æ¸…ç©ºæ–‡æœ¬æ¡†
            textarea.value = '';
            
            alert(`æˆåŠŸè¯†åˆ« ${casts.length} ä½æ¼”å‘˜ï¼`);
        }
        
        // åˆ é™¤è§’è‰²
        function removeRole(roleId) {
            const roleDiv = document.getElementById(`role-${roleId}`);
            if (roleDiv) {
                roleDiv.remove();
            }
        }
        
        // å‹ç¼©å›¾ç‰‡
        function compressImage(base64Str, maxWidth = 800, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    // å¦‚æœå›¾ç‰‡å®½åº¦è¶…è¿‡maxWidthï¼ŒæŒ‰æ¯”ä¾‹ç¼©æ”¾
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // è½¬æ¢ä¸ºbase64ï¼Œä½¿ç”¨æŒ‡å®šçš„è´¨é‡
                    const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                    
                    console.log('å›¾ç‰‡å‹ç¼©:', 
                        'åŸå§‹å¤§å°:', Math.round(base64Str.length / 1024), 'KB',
                        'â†’ å‹ç¼©å:', Math.round(compressedBase64.length / 1024), 'KB'
                    );
                    
                    resolve(compressedBase64);
                };
                img.onerror = reject;
                img.src = base64Str;
            });
        }
        
        // å¤„ç†æµ·æŠ¥ä¸Šä¼ 
        document.addEventListener('DOMContentLoaded', function() {
            const posterInput = document.getElementById('showInfoPoster');
            if (posterInput) {
                posterInput.addEventListener('change', async function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = async function(event) {
                            const originalBase64 = event.target.result;
                            
                            // å‹ç¼©å›¾ç‰‡
                            try {
                                tempPoster = await compressImage(originalBase64, 800, 0.7);
                                document.getElementById('posterPreview').innerHTML = `
                                    <img src="${tempPoster}" style="max-width: 200px; border-radius: 8px;">
                                    <p style="font-size: 0.8em; color: var(--text-secondary); margin-top: 5px;">
                                        å·²å‹ç¼©: ${Math.round(tempPoster.length / 1024)} KB
                                    </p>
                                `;
                            } catch (error) {
                                console.error('å›¾ç‰‡å‹ç¼©å¤±è´¥:', error);
                                // å‹ç¼©å¤±è´¥åˆ™ä½¿ç”¨åŸå›¾
                                tempPoster = originalBase64;
                                document.getElementById('posterPreview').innerHTML = `
                                    <img src="${tempPoster}" style="max-width: 200px; border-radius: 8px;">
                                `;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // å‰§ç›®ä¿¡æ¯è¡¨å•æäº¤
            const showInfoForm = document.getElementById('showInfoForm');
            if (showInfoForm) {
                showInfoForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveShowInfo();
                });
            }
        });
        
        // ä¿å­˜å‰§ç›®ä¿¡æ¯
        function saveShowInfo() {
            const id = document.getElementById('showInfoId').value;
            const name = document.getElementById('showInfoName').value.trim();
            const venue = document.getElementById('showInfoVenue').value.trim();
            
            if (!name) {
                alert('è¯·è¾“å…¥å‰§ç›®åç§°');
                return;
            }
            
            // æ”¶é›†è§’è‰²å’Œå¡å¸ä¿¡æ¯
            const roles = [];
            const roleInputs = document.querySelectorAll('.role-input-group');
            
            roleInputs.forEach(roleDiv => {
                const roleNameInput = roleDiv.querySelector('.role-name-input');
                const roleName = roleNameInput ? roleNameInput.value.trim() : '';
                
                if (roleName) {
                    const castInputs = roleDiv.querySelectorAll('.cast-input');
                    const casts = Array.from(castInputs)
                        .map(input => input.value.trim())
                        .filter(cast => cast);
                    
                    if (casts.length > 0) {
                        roles.push({
                            roleName: roleName,
                            casts: casts
                        });
                    }
                }
            });
            
            const showInfo = {
                id: id ? parseInt(id) : Date.now(),
                name: name,
                venue: venue,
                poster: tempPoster,
                roles: roles,
                createdAt: new Date().toISOString()
            };
            
            if (id) {
                // æ›´æ–°ç°æœ‰å‰§ç›®
                const index = showsInfo.findIndex(s => s.id === parseInt(id));
                if (index !== -1) {
                    showsInfo[index] = showInfo;
                }
            } else {
                // æ·»åŠ æ–°å‰§ç›®
                showsInfo.push(showInfo);
            }
            
            saveShowsInfo();
            closeShowInfoModal();
            renderShowInfoList();
            alert('å‰§ç›®ä¿¡æ¯ä¿å­˜æˆåŠŸï¼');
        }
        
        // ç¼–è¾‘å‰§ç›®ä¿¡æ¯
        function editShowInfo(id) {
            const show = showsInfo.find(s => s.id === id);
            if (!show) return;
            
            document.getElementById('showInfoModalTitle').textContent = 'ç¼–è¾‘å‰§ç›®ä¿¡æ¯';
            document.getElementById('showInfoId').value = show.id;
            document.getElementById('showInfoName').value = show.name;
            document.getElementById('showInfoVenue').value = show.venue || '';
            
            // æ˜¾ç¤ºæµ·æŠ¥
            if (show.poster) {
                tempPoster = show.poster;
                document.getElementById('posterPreview').innerHTML = `
                    <img src="${show.poster}" style="max-width: 200px; border-radius: 8px;">
                `;
            } else {
                tempPoster = null;
                document.getElementById('posterPreview').innerHTML = '';
            }
            
            // åŠ è½½è§’è‰²å’Œå¡å¸
            const rolesContainer = document.getElementById('rolesContainer');
            rolesContainer.innerHTML = '';
            roleInputCounter = 0;
            
            if (show.roles && show.roles.length > 0) {
                show.roles.forEach(role => {
                    const roleId = roleInputCounter++;
                    const roleDiv = document.createElement('div');
                    roleDiv.className = 'role-input-group';
                    roleDiv.id = `role-${roleId}`;
                    
                    const castsHtml = role.casts.map((cast, idx) => `
                        <div class="cast-input-row">
                            <input type="text" placeholder="æ¼”å‘˜åå­—" class="cast-input" value="${cast}">
                            ${idx === 0 ? 
                                `<button type="button" class="btn btn-secondary btn-add-small" onclick="addCastInput(${roleId})">+ æ¼”å‘˜</button>` :
                                `<button type="button" class="btn-remove" onclick="this.parentElement.remove()">åˆ é™¤</button>`
                            }
                        </div>
                    `).join('');
                    
                    roleDiv.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <input type="text" placeholder="è§’è‰²åç§°" value="${role.roleName}"
                                   class="role-name-input" style="flex: 1; margin-right: 10px;">
                            <button type="button" class="btn-remove" onclick="removeRole(${roleId})">åˆ é™¤è§’è‰²</button>
                        </div>
                        
                        <div class="batch-parse-section" style="margin-bottom: 10px;">
                            <label style="font-weight: 600; margin-bottom: 5px; display: block; font-size: 0.9em;">æ‰¹é‡æ·»åŠ æ¼”å‘˜</label>
                            <textarea id="role-batch-${roleId}" class="batch-parse-textarea" 
                                      style="min-height: 60px; font-size: 0.9em;"
                                      placeholder="ç²˜è´´æ¼”å‘˜åˆ—è¡¨&#10;ä¾‹å¦‚ï¼šå¼ ä¸‰&#10;æå››&#10;ç‹äº”"></textarea>
                            <button type="button" class="btn btn-secondary btn-add-small" 
                                    onclick="parseBatchCastsForRole(${roleId})" 
                                    style="margin-top: 5px;">
                                âœ“ è¯†åˆ«å¹¶æ·»åŠ 
                            </button>
                        </div>
                        
                        <div class="casts-container" id="casts-${roleId}">
                            ${castsHtml}
                        </div>
                    `;
                    
                    rolesContainer.appendChild(roleDiv);
                });
            } else {
                addRoleInput();
            }
            
            document.getElementById('showInfoModal').classList.add('active');
        }
        
        // åˆ é™¤å‰§ç›®ä¿¡æ¯
        function deleteShowInfo(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå‰§ç›®ä¿¡æ¯å—ï¼Ÿ')) {
                showsInfo = showsInfo.filter(s => s.id !== id);
                saveShowsInfo();
                renderShowInfoList(); // åˆ é™¤åè¿”å›åˆ—è¡¨è§†å›¾
            }
        }
        
        // å…³é—­å‰§ç›®ä¿¡æ¯æ¨¡æ€æ¡†
        function closeShowInfoModal() {
            document.getElementById('showInfoModal').classList.remove('active');
            tempPoster = null;
        }
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®
        function clearAllData() {
            if (records.length === 0) {
                alert('å½“å‰æ²¡æœ‰ä»»ä½•æ•°æ®');
                return;
            }
            
            const confirmation = confirm(
                `è­¦å‘Šï¼šæ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰ ${records.length} æ¡è®°å½•ï¼\n\n` +
                `æ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œå»ºè®®å…ˆå¯¼å‡ºå¤‡ä»½ã€‚\n\n` +
                `ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ`
            );
            
            if (!confirmation) return;
            
            const finalConfirmation = confirm('æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ');
            
            if (finalConfirmation) {
                records = [];
                saveRecords();
                loadRecords();
                alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©º');
            }
        }

        // ============ GitHub åŒæ­¥åŠŸèƒ½ ============
        
        // åŠ è½½GitHubé…ç½®
        function loadGitHubConfig() {
            const savedToken = localStorage.getItem('githubToken');
            if (savedToken) {
                GITHUB_CONFIG.token = savedToken;
                updateSyncStatus();
            }
        }
        
        // ä¿å­˜GitHub Token
        function saveGitHubToken() {
            const token = document.getElementById('githubToken').value.trim();
            
            if (!token) {
                alert('è¯·è¾“å…¥GitHub Token');
                return;
            }
            
            if (!token.startsWith('ghp_')) {
                alert('Tokenæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ ghp_ å¼€å¤´');
                return;
            }
            
            GITHUB_CONFIG.token = token;
            localStorage.setItem('githubToken', token);
            
            // æµ‹è¯•è¿æ¥
            testGitHubConnection().then(success => {
                if (success) {
                    alert('Tokenä¿å­˜æˆåŠŸï¼GitHubåŒæ­¥å·²å¯ç”¨\n\nç°åœ¨ä½ çš„æ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°GitHub');
                    updateSyncStatus();
                }
            });
        }
        
        // æµ‹è¯•GitHubè¿æ¥
        async function testGitHubConnection() {
            if (!GITHUB_CONFIG.token) {
                alert('è¯·å…ˆé…ç½®GitHub Token');
                return false;
            }
            
            updateSyncStatus('æµ‹è¯•ä¸­...');
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    updateSyncStatus('å·²å¯ç”¨ âœ“', 'è¿æ¥æ­£å¸¸ï¼Œè‡ªåŠ¨åŒæ­¥å·²å¼€å¯');
                    alert('è¿æ¥æˆåŠŸï¼\nå¯ä»¥æ­£å¸¸è®¿é—®ä½ çš„GitHubä»“åº“');
                    return true;
                } else if (response.status === 401) {
                    updateSyncStatus('æœªå¯ç”¨', 'Tokenæ— æ•ˆï¼Œè¯·æ£€æŸ¥');
                    alert('Tokenæ— æ•ˆï¼\nè¯·æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®ï¼Œæˆ–æ˜¯å¦å·²è¿‡æœŸ');
                    return false;
                } else if (response.status === 404) {
                    updateSyncStatus('æœªå¯ç”¨', 'ä»“åº“ä¸å­˜åœ¨');
                    alert('æ‰¾ä¸åˆ°ä»“åº“ï¼\nè¯·æ£€æŸ¥ç”¨æˆ·åå’Œä»“åº“åæ˜¯å¦æ­£ç¡®');
                    return false;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                console.error('æµ‹è¯•è¿æ¥å¤±è´¥:', error);
                updateSyncStatus('æœªå¯ç”¨', 'è¿æ¥å¤±è´¥: ' + error.message);
                alert('è¿æ¥å¤±è´¥ï¼š' + error.message + '\n\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return false;
            }
        }
        
        // åŒæ­¥æ•°æ®åˆ°GitHub
        async function syncToGitHub() {
            console.log('=== å¼€å§‹åŒæ­¥åˆ°GitHub ===');
            console.log('Tokené…ç½®:', GITHUB_CONFIG.token ? 'å·²é…ç½®' : 'æœªé…ç½®');
            console.log('ä»“åº“:', `${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}`);
            
            if (!GITHUB_CONFIG.token) {
                console.log('æœªé…ç½®GitHub Tokenï¼Œè·³è¿‡åŒæ­¥');
                return;
            }
            
            if (isSyncing) {
                console.log('æ­£åœ¨åŒæ­¥ä¸­ï¼Œè·³è¿‡æœ¬æ¬¡åŒæ­¥');
                return;
            }
            
            isSyncing = true;
            updateSyncStatus('åŒæ­¥ä¸­...');
            
            try {
                // 1. è·å–å½“å‰æ–‡ä»¶çš„SHAï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                let sha = null;
                try {
                    const getResponse = await fetch(
                        `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`,
                        {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        }
                    );
                    
                    if (getResponse.ok) {
                        const data = await getResponse.json();
                        sha = data.sha;
                    }
                } catch (e) {
                    console.log('æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶');
                }
                
                // 2. ä¸Šä¼ æ•°æ®ï¼ˆåŒ…å«recordsã€showsInfoå’ŒmanualWatchCountsï¼‰
                const timestamp = new Date().toISOString();
                const allData = {
                    records: records,
                    showsInfo: showsInfo,
                    manualWatchCounts: manualWatchCounts,
                    lastUpdate: timestamp
                };
                
                console.log('å‡†å¤‡åŒæ­¥æ•°æ®:', {
                    records: records.length,
                    showsInfo: showsInfo.length,
                    manualWatchCounts: Object.keys(manualWatchCounts).length
                });
                
                const jsonString = JSON.stringify(allData, null, 2);
                const jsonSize = jsonString.length;
                const jsonSizeMB = (jsonSize / 1024 / 1024).toFixed(2);
                console.log('JSONå­—ç¬¦ä¸²å¤§å°:', jsonSize, 'å­—ç¬¦ (', jsonSizeMB, 'MB)');
                
                // GitHub APIé™åˆ¶å•ä¸ªæ–‡ä»¶ä¸è¶…è¿‡100MBï¼Œä½†å»ºè®®ä¿æŒåœ¨1MBä»¥ä¸‹
                if (jsonSize > 1024 * 1024) {
                    console.warn('è­¦å‘Šï¼šæ•°æ®é‡è¾ƒå¤§ï¼Œå¯èƒ½å½±å“åŒæ­¥é€Ÿåº¦');
                }
                if (jsonSize > 10 * 1024 * 1024) {
                    throw new Error(`æ•°æ®è¿‡å¤§(${jsonSizeMB}MB)ï¼ŒGitHub APIé™åˆ¶ä¸º100MBã€‚è¯·è€ƒè™‘å‡å°‘å›¾ç‰‡æ•°é‡æˆ–å‹ç¼©å›¾ç‰‡ã€‚`);
                }
                
                // Base64ç¼–ç 
                let content;
                try {
                    content = btoa(unescape(encodeURIComponent(jsonString)));
                } catch (e) {
                    console.error('Base64ç¼–ç å¤±è´¥:', e);
                    throw new Error('æ•°æ®ç¼–ç å¤±è´¥: ' + e.message);
                }
                
                const updateData = {
                    message: `æ›´æ–°è§‚æ¼”è®°å½• - ${new Date().toLocaleString('zh-CN')}`,
                    content: content,
                    branch: GITHUB_CONFIG.branch
                };
                
                if (sha) {
                    updateData.sha = sha;
                }
                
                const putResponse = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`,
                    {
                        method: 'PUT',
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );
                
                if (!putResponse.ok) {
                    const errorBody = await putResponse.text();
                    console.error('GitHub APIé”™è¯¯å“åº”:', errorBody);
                    throw new Error(`ä¸Šä¼ å¤±è´¥ (${putResponse.status}): ${errorBody}`);
                }
                
                console.log('âœ“ æ•°æ®å·²æˆåŠŸåŒæ­¥åˆ°GitHub');
                
                // ä¿å­˜æœ¬åœ°åŒæ­¥æ—¶é—´æˆ³
                localStorage.setItem('lastSyncTime', timestamp);
                
                console.log('=== åŒæ­¥å®Œæˆ ===');
                updateSyncStatus('å·²å¯ç”¨ âœ“', `æœ€ååŒæ­¥: ${new Date().toLocaleTimeString('zh-CN')}`);
                
            } catch (error) {
                console.error('=== åŒæ­¥åˆ°GitHubå¤±è´¥ ===');
                console.error('é”™è¯¯ç±»å‹:', error.name);
                console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                console.error('å®Œæ•´é”™è¯¯:', error);
                
                let errorMsg = 'åŒæ­¥å¤±è´¥';
                if (error.message.includes('404')) {
                    errorMsg = 'ä»“åº“ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®';
                } else if (error.message.includes('401')) {
                    errorMsg = 'Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ';
                } else if (error.message.includes('403')) {
                    errorMsg = 'Tokenæƒé™ä¸è¶³ï¼ˆéœ€è¦repoæƒé™ï¼‰';
                } else if (error.message.includes('æ•°æ®è¿‡å¤§')) {
                    errorMsg = 'æ•°æ®è¿‡å¤§';
                }
                
                updateSyncStatus(errorMsg, error.message);
                console.log('ç»§ç»­ä½¿ç”¨æœ¬åœ°æ•°æ®');
                console.log('=== åŒæ­¥ç»“æŸï¼ˆå¤±è´¥ï¼‰===');
            } finally {
                isSyncing = false;
            }
        }
        
        // ä»GitHubåŠ è½½æ•°æ®
        async function syncFromGitHub() {
            if (!GITHUB_CONFIG.token) {
                console.log('æœªé…ç½®GitHub Tokenï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®');
                return;
            }
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.dataFile}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (response.ok) {
                    const data = await response.json();
                    
                    console.log('GitHub APIå“åº”ç±»å‹:', data.type);
                    console.log('GitHub APIå“åº”å¤§å°:', data.size);
                    
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶ï¼ˆè€Œä¸æ˜¯ç›®å½•ï¼‰
                    if (data.type === 'dir') {
                        console.error('è·¯å¾„æŒ‡å‘ç›®å½•è€Œéæ–‡ä»¶');
                        throw new Error('æ•°æ®æ–‡ä»¶è·¯å¾„é”™è¯¯ï¼šæŒ‡å‘çš„æ˜¯ç›®å½•è€Œéæ–‡ä»¶');
                    }
                    
                    let content;
                    
                    // å¦‚æœæ–‡ä»¶å¤ªå¤§ï¼ˆ>1MBï¼‰ï¼ŒGitHub APIä¸è¿”å›contentï¼Œéœ€è¦ç”¨download_url
                    if (!data.content || data.encoding === 'none') {
                        console.log('æ–‡ä»¶è¾ƒå¤§ï¼Œä½¿ç”¨download_urlä¸‹è½½...');
                        
                        if (!data.download_url) {
                            console.error('GitHubå®Œæ•´å“åº”:', JSON.stringify(data, null, 2));
                            throw new Error('æ— æ³•è·å–æ–‡ä»¶å†…å®¹ï¼šç¼ºå°‘download_url');
                        }
                        
                        // é€šè¿‡download_urlè·å–æ–‡ä»¶å†…å®¹
                        const downloadResponse = await fetch(data.download_url);
                        if (!downloadResponse.ok) {
                            throw new Error(`ä¸‹è½½æ–‡ä»¶å¤±è´¥: ${downloadResponse.status}`);
                        }
                        content = await downloadResponse.text();
                        console.log('æ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå¤§å°:', Math.round(content.length / 1024), 'KB');
                    } else {
                        // æ–‡ä»¶è¾ƒå°ï¼Œç›´æ¥ä»contentè§£ç 
                        console.log('ä»APIå“åº”ä¸­è§£ç content...');
                        
                        // ç§»é™¤contentä¸­çš„æ¢è¡Œç¬¦ï¼ˆGitHub APIä¼šåœ¨base64ä¸­æ’å…¥æ¢è¡Œï¼‰
                        const cleanContent = data.content.replace(/\n/g, '');
                        
                        // è§£ç Base64å†…å®¹
                        try {
                            content = decodeURIComponent(escape(atob(cleanContent)));
                        } catch (e) {
                            console.error('Base64è§£ç å¤±è´¥:', e);
                            throw new Error('æ•°æ®è§£ç å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æŸå');
                        }
                    }
                    
                    // è§£æJSON
                    let githubData;
                    try {
                        githubData = JSON.parse(content);
                    } catch (e) {
                        console.error('JSONè§£æå¤±è´¥:', e);
                        console.error('å†…å®¹é¢„è§ˆ:', content.substring(0, 200));
                        throw new Error('æ•°æ®æ ¼å¼é”™è¯¯ï¼ŒJSONè§£æå¤±è´¥');
                    }
                    
                    // å…¼å®¹æ—§æ ¼å¼ï¼ˆåªæœ‰recordsæ•°ç»„ï¼‰å’Œæ–°æ ¼å¼ï¼ˆåŒ…å«recordsã€showsInfoã€manualWatchCountsï¼‰
                    let githubRecords, githubShowsInfo, githubManualCounts, githubLastUpdate;
                    
                    if (Array.isArray(githubData)) {
                        // æ—§æ ¼å¼ï¼šç›´æ¥æ˜¯recordsæ•°ç»„
                        githubRecords = githubData;
                        githubShowsInfo = [];
                        githubManualCounts = {};
                        githubLastUpdate = null;
                    } else {
                        // æ–°æ ¼å¼ï¼šåŒ…å«å¤šä¸ªå­—æ®µçš„å¯¹è±¡
                        githubRecords = githubData.records || [];
                        githubShowsInfo = githubData.showsInfo || [];
                        githubManualCounts = githubData.manualWatchCounts || {};
                        githubLastUpdate = githubData.lastUpdate;
                    }
                    
                    console.log('GitHubæ•°æ®:', {
                        records: githubRecords.length,
                        showsInfo: githubShowsInfo.length,
                        manualCounts: Object.keys(githubManualCounts).length,
                        lastUpdate: githubLastUpdate
                    });
                    
                    // åˆå¹¶æ•°æ®
                    const localRecords = JSON.parse(localStorage.getItem('musicalRecords') || '[]');
                    const localShowsInfo = JSON.parse(localStorage.getItem('showsInfo') || '[]');
                    const localManualCounts = JSON.parse(localStorage.getItem('manualWatchCounts') || '{}');
                    const localLastUpdate = localStorage.getItem('lastSyncTime');
                    
                    console.log('æœ¬åœ°æ•°æ®:', {
                        records: localRecords.length,
                        showsInfo: localShowsInfo.length,
                        manualCounts: Object.keys(localManualCounts).length,
                        lastUpdate: localLastUpdate
                    });
                    
                    // ä½¿ç”¨æ—¶é—´æˆ³æ¯”è¾ƒï¼ˆå¦‚æœéƒ½æœ‰æ—¶é—´æˆ³ï¼‰
                    let useGitHub = false;
                    
                    if (githubLastUpdate && localLastUpdate) {
                        // éƒ½æœ‰æ—¶é—´æˆ³ï¼Œæ¯”è¾ƒæ—¶é—´
                        const githubTime = new Date(githubLastUpdate).getTime();
                        const localTime = new Date(localLastUpdate).getTime();
                        
                        console.log('æ—¶é—´æˆ³æ¯”è¾ƒ:', {
                            github: githubLastUpdate,
                            local: localLastUpdate,
                            githubTime: githubTime,
                            localTime: localTime
                        });
                        
                        if (githubTime > localTime) {
                            console.log('GitHubæ•°æ®æ›´æ–°ï¼ˆæ ¹æ®æ—¶é—´æˆ³ï¼‰');
                            useGitHub = true;
                        } else if (localTime > githubTime) {
                            console.log('æœ¬åœ°æ•°æ®æ›´æ–°ï¼ˆæ ¹æ®æ—¶é—´æˆ³ï¼‰ï¼Œå°†åŒæ­¥åˆ°GitHub');
                            records = localRecords;
                            showsInfo = localShowsInfo;
                            manualWatchCounts = localManualCounts;
                            await syncToGitHub();
                            return;
                        } else {
                            console.log('æ•°æ®å·²åŒæ­¥ï¼ˆæ—¶é—´æˆ³ç›¸åŒï¼‰');
                            useGitHub = true; // ä½¿ç”¨GitHubæ•°æ®ä¿æŒä¸€è‡´
                        }
                    } else if (githubLastUpdate && !localLastUpdate) {
                        // åªæœ‰GitHubæœ‰æ—¶é—´æˆ³ï¼Œè¯´æ˜GitHubæ˜¯æ–°æ ¼å¼ï¼Œä¼˜å…ˆä½¿ç”¨
                        console.log('GitHubæœ‰æ—¶é—´æˆ³ï¼Œæœ¬åœ°æ— æ—¶é—´æˆ³ï¼Œä½¿ç”¨GitHubæ•°æ®');
                        useGitHub = true;
                    } else if (!githubLastUpdate && localLastUpdate) {
                        // åªæœ‰æœ¬åœ°æœ‰æ—¶é—´æˆ³ï¼Œè¯´æ˜æœ¬åœ°æ˜¯æ–°æ ¼å¼ï¼Œä¸Šä¼ åˆ°GitHub
                        console.log('æœ¬åœ°æœ‰æ—¶é—´æˆ³ï¼ŒGitHubæ— æ—¶é—´æˆ³ï¼Œä¸Šä¼ æœ¬åœ°æ•°æ®');
                        records = localRecords;
                        showsInfo = localShowsInfo;
                        manualWatchCounts = localManualCounts;
                        await syncToGitHub();
                        return;
                    } else {
                        // éƒ½æ²¡æœ‰æ—¶é—´æˆ³ï¼Œä½¿ç”¨æ•°é‡æ¯”è¾ƒï¼ˆå‘åå…¼å®¹ï¼‰
                        console.log('éƒ½æ— æ—¶é—´æˆ³ï¼Œä½¿ç”¨æ•°é‡æ¯”è¾ƒ');
                        const githubTotal = githubRecords.length + githubShowsInfo.length;
                        const localTotal = localRecords.length + localShowsInfo.length;
                        
                        console.log('æ•°é‡æ¯”è¾ƒ:', { githubTotal, localTotal });
                        
                        if (githubTotal > localTotal) {
                            console.log('GitHubæ•°æ®è¾ƒå¤šï¼ˆæ ¹æ®æ•°é‡ï¼‰');
                            useGitHub = true;
                        } else if (localTotal > githubTotal) {
                            console.log('æœ¬åœ°æ•°æ®è¾ƒå¤šï¼ˆæ ¹æ®æ•°é‡ï¼‰ï¼Œå°†åŒæ­¥åˆ°GitHub');
                            records = localRecords;
                            showsInfo = localShowsInfo;
                            manualWatchCounts = localManualCounts;
                            await syncToGitHub();
                            return;
                        } else {
                            console.log('æ•°é‡ç›¸åŒï¼Œä½¿ç”¨GitHubæ•°æ®');
                            useGitHub = true;
                        }
                    }
                    
                    if (useGitHub) {
                        records = githubRecords;
                        showsInfo = githubShowsInfo;
                        manualWatchCounts = githubManualCounts;
                        
                        localStorage.setItem('musicalRecords', JSON.stringify(records));
                        localStorage.setItem('showsInfo', JSON.stringify(showsInfo));
                        localStorage.setItem('manualWatchCounts', JSON.stringify(manualWatchCounts));
                        if (githubLastUpdate) {
                            localStorage.setItem('lastSyncTime', githubLastUpdate);
                        }
                        
                        console.log('å·²ä»GitHubåŠ è½½æ•°æ®');
                    }
                    
                    updateSyncStatus('å·²å¯ç”¨ âœ“', `å·²åŠ è½½ ${records.length} æ¡è®°å½•, ${showsInfo.length} ä¸ªå‰§ç›®`);
                } else if (response.status === 404) {
                    console.log('GitHubä¸Šè¿˜æ²¡æœ‰æ•°æ®æ–‡ä»¶ï¼Œå°†ä¸Šä¼ æœ¬åœ°æ•°æ®');
                    if (records.length > 0 || showsInfo.length > 0) {
                        await syncToGitHub();
                    }
                } else {
                    throw new Error(`åŠ è½½å¤±è´¥: ${response.status}`);
                }
            } catch (error) {
                console.error('ä»GitHubåŠ è½½å¤±è´¥:', error);
                throw error;
            }
        }
        
        // æ‰‹åŠ¨åŒæ­¥
        async function manualSync() {
            if (!GITHUB_CONFIG.token) {
                alert('è¯·å…ˆé…ç½®GitHub Token');
                return;
            }
            
            console.log('å¼€å§‹æ‰‹åŠ¨åŒæ­¥...');
            
            try {
                // å…ˆå°è¯•ä»GitHubæ‹‰å–
                let pullSuccess = false;
                try {
                    await syncFromGitHub();
                    pullSuccess = true;
                    console.log('âœ“ ä»GitHubæ‹‰å–æˆåŠŸ');
                } catch (error) {
                    console.log('ä»GitHubæ‹‰å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ç¬¬ä¸€æ¬¡åŒæ­¥ï¼‰:', error.message);
                    // å¿½ç•¥æ‹‰å–å¤±è´¥ï¼Œç»§ç»­ä¸Šä¼ 
                }
                
                // ä¸Šä¼ åˆ°GitHub
                console.log('å¼€å§‹ä¸Šä¼ åˆ°GitHub...');
                await syncToGitHub();
                console.log('âœ“ ä¸Šä¼ åˆ°GitHubæˆåŠŸ');
                
                let message = `åŒæ­¥æˆåŠŸï¼\nå·²åŒæ­¥ ${records.length} æ¡è®°å½•, ${showsInfo.length} ä¸ªå‰§ç›®`;
                if (!pullSuccess) {
                    message += '\n\nï¼ˆè¿™æ˜¯é¦–æ¬¡åŒæ­¥ï¼Œå·²å°†æœ¬åœ°æ•°æ®ä¸Šä¼ åˆ°GitHubï¼‰';
                }
                
                alert(message);
                loadRecords();
                renderCalendar();
                renderShowInfoList();
            } catch (error) {
                console.error('åŒæ­¥å¤±è´¥ï¼Œå®Œæ•´é”™è¯¯:', error);
                alert('åŒæ­¥å¤±è´¥ï¼š' + error.message + '\n\nè¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°(F12)');
            }
        }
        
        // æ›´æ–°åŒæ­¥çŠ¶æ€æ˜¾ç¤º
        function updateSyncStatus(status, detail) {
            const statusText = document.getElementById('syncStatusText');
            const statusDetail = document.getElementById('syncStatusDetail');
            
            if (statusText && status) {
                statusText.textContent = status;
            }
            
            if (statusDetail && detail) {
                statusDetail.textContent = detail;
            }
            
            // æ ¹æ®tokenæ˜¯å¦å­˜åœ¨æ›´æ–°é»˜è®¤çŠ¶æ€
            if (!status && GITHUB_CONFIG.token) {
                if (statusText) statusText.textContent = 'å·²å¯ç”¨ âœ“';
                if (statusDetail) statusDetail.textContent = 'è‡ªåŠ¨åŒæ­¥å·²å¼€å¯';
            } else if (!status && !GITHUB_CONFIG.token) {
                if (statusText) statusText.textContent = 'æœªå¯ç”¨';
                if (statusDetail) statusDetail.textContent = 'è¯·å…ˆé…ç½®GitHub Token';
            }
        }
    </script>
</body>
</html>